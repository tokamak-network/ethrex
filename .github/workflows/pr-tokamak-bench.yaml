name: Tokamak Benchmark

on:
  pull_request:
    branches: ["**"]
    paths:
      - "crates/vm/levm/**"
      - "crates/tokamak-bench/**"
      - "crates/vm/tokamak-jit/**"
      - ".github/workflows/pr-tokamak-bench.yaml"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  issues: write
  pull-requests: write

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  CARGO_NET_RETRY: "10"

jobs:
  bench-pr:
    name: Benchmark PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install solc
        uses: ./.github/actions/install-solc

      - name: Compile benchmark contracts
        run: |
          cd crates/vm/levm
          make compile-contracts

      - name: Build tokamak-bench
        run: cargo build --release -p tokamak-bench

      - name: Run benchmarks
        run: |
          target/release/tokamak-bench run \
            --runs 10 \
            --commit "${{ github.event.pull_request.head.sha }}" \
            --output bench-pr.json

      - name: Upload PR results
        uses: actions/upload-artifact@v4
        with:
          name: bench-pr
          path: bench-pr.json

  bench-main:
    name: Benchmark Main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install solc
        uses: ./.github/actions/install-solc

      - name: Compile benchmark contracts
        run: |
          cd crates/vm/levm
          make compile-contracts

      - name: Check if tokamak-bench exists
        id: check
        run: |
          if cargo metadata --no-deps --format-version 1 2>/dev/null | grep -q '"name":"tokamak-bench"'; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "::warning::tokamak-bench not found on base branch — skipping baseline benchmark"
          fi

      - name: Build tokamak-bench
        if: steps.check.outputs.exists == 'true'
        run: cargo build --release -p tokamak-bench

      - name: Run benchmarks
        if: steps.check.outputs.exists == 'true'
        run: |
          target/release/tokamak-bench run \
            --runs 10 \
            --commit "${{ github.event.pull_request.base.sha }}" \
            --output bench-main.json

      - name: Upload main results
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: bench-main
          path: bench-main.json

  compare-results:
    name: Compare Results
    runs-on: ubuntu-latest
    needs: [bench-pr, bench-main]
    if: always() && needs.bench-pr.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Build tokamak-bench
        run: cargo build --release -p tokamak-bench

      - name: Download PR results
        uses: actions/download-artifact@v4
        with:
          name: bench-pr
          path: ./results

      - name: Download main results
        id: download-main
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: bench-main
          path: ./results

      - name: Compare benchmarks
        id: compare
        continue-on-error: true
        if: steps.download-main.outcome == 'success'
        run: |
          target/release/tokamak-bench compare \
            --baseline results/bench-main.json \
            --current results/bench-pr.json \
            --output comparison.json

      - name: Upload comparison artifact
        if: steps.compare.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: bench-comparison
          path: comparison.json

      - name: Generate report
        if: steps.download-main.outcome == 'success'
        run: |
          target/release/tokamak-bench report \
            --input comparison.json \
            --output report.md

      - name: Generate first-run report
        if: steps.download-main.outcome != 'success'
        run: |
          {
            echo "## Tokamak Benchmark Results: **Baseline**"
            echo ""
            echo "No baseline benchmark found on the base branch."
            echo "This PR establishes the initial benchmark baseline."
          } > report.md

      - name: Find comment
        continue-on-error: true
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Tokamak Benchmark Results"

      - name: Post PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: report.md
          edit-mode: replace

  # ─── JIT Benchmark Jobs ─────────────────────────────────────────────
  # Requires LLVM 21 for revmc backend (C-2: provisioned via install-llvm action).

  jit-bench-pr:
    name: JIT Benchmark PR
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install LLVM 21
        uses: ./.github/actions/install-llvm

      - name: Install solc
        uses: ./.github/actions/install-solc

      - name: Compile benchmark contracts
        run: |
          cd crates/vm/levm
          make compile-contracts

      - name: Build tokamak-bench with JIT
        run: cargo build --release -p tokamak-bench --features jit-bench

      - name: Run JIT benchmarks
        run: |
          target/release/tokamak-bench jit-bench \
            --runs 10 \
            --commit "${{ github.event.pull_request.head.sha }}" \
            --output jit-bench-pr.json

      - name: Upload JIT PR results
        uses: actions/upload-artifact@v4
        with:
          name: jit-bench-pr
          path: jit-bench-pr.json

  jit-bench-main:
    name: JIT Benchmark Main
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install LLVM 21
        uses: ./.github/actions/install-llvm

      - name: Install solc
        uses: ./.github/actions/install-solc

      - name: Compile benchmark contracts
        run: |
          cd crates/vm/levm
          make compile-contracts

      - name: Check if tokamak-bench exists
        id: check
        run: |
          if cargo metadata --no-deps --format-version 1 2>/dev/null | grep -q '"name":"tokamak-bench"'; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "::warning::tokamak-bench not found on base branch"
          fi

      - name: Build tokamak-bench with JIT
        if: steps.check.outputs.exists == 'true'
        run: cargo build --release -p tokamak-bench --features jit-bench

      - name: Run JIT benchmarks
        if: steps.check.outputs.exists == 'true'
        run: |
          target/release/tokamak-bench jit-bench \
            --runs 10 \
            --commit "${{ github.event.pull_request.base.sha }}" \
            --output jit-bench-main.json

      - name: Upload JIT main results
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: jit-bench-main
          path: jit-bench-main.json

  compare-jit-results:
    name: Compare JIT Results
    runs-on: ubuntu-latest
    needs: [jit-bench-pr, jit-bench-main]
    if: always() && needs.jit-bench-pr.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Build tokamak-bench
        run: cargo build --release -p tokamak-bench

      - name: Download JIT PR results
        uses: actions/download-artifact@v4
        with:
          name: jit-bench-pr
          path: ./results

      - name: Download JIT main results
        id: download-main
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: jit-bench-main
          path: ./results

      - name: Compare JIT speedup
        id: compare-jit
        continue-on-error: true
        if: steps.download-main.outcome == 'success'
        run: |
          target/release/tokamak-bench jit-compare \
            --baseline results/jit-bench-main.json \
            --current results/jit-bench-pr.json \
            --threshold 20.0 \
            --output jit-report.md

      - name: Generate first-run JIT report
        if: steps.download-main.outcome != 'success'
        run: |
          {
            echo "## JIT Speedup Regression: **Baseline**"
            echo ""
            echo "No baseline JIT benchmark found on the base branch."
            echo "This PR establishes the initial JIT benchmark baseline."
          } > jit-report.md

      - name: Find JIT comment
        continue-on-error: true
        uses: peter-evans/find-comment@v3
        id: fc-jit
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "JIT Speedup Regression"

      - name: Post JIT PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc-jit.outputs.comment-id }}
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: jit-report.md
          edit-mode: replace

  # ─── Dashboard Data Publishing ────────────────────────────────────
  # Collects benchmark artifacts and publishes to gh-pages branch for
  # the public dashboard at clients.tokamak.network.

  publish-dashboard:
    name: Publish Dashboard Data
    runs-on: ubuntu-latest
    needs: [compare-results, compare-jit-results]
    if: always() && needs.compare-results.result == 'success' && github.event.pull_request.merged == true
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download PR bench results
        uses: actions/download-artifact@v4
        with:
          name: bench-pr
          path: ./artifacts

      - name: Download JIT bench results
        id: dl-jit
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: jit-bench-pr
          path: ./artifacts

      - name: Download comparison results
        id: dl-comparison
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: bench-comparison
          path: ./artifacts

      - name: Prepare data directory
        shell: bash
        run: |
          DATE=$(date -u +%Y-%m-%d)
          COMMIT="${{ github.event.pull_request.head.sha }}"
          SHORT_COMMIT="${COMMIT:0:9}"
          DATA_DIR="data/${DATE}"
          mkdir -p "${DATA_DIR}"

          cp artifacts/bench-pr.json "${DATA_DIR}/${SHORT_COMMIT}-bench.json"

          if [ -f artifacts/jit-bench-pr.json ]; then
            cp artifacts/jit-bench-pr.json "${DATA_DIR}/${SHORT_COMMIT}-jit-bench.json"
          fi

          if [ -f artifacts/comparison.json ]; then
            cp artifacts/comparison.json "${DATA_DIR}/${SHORT_COMMIT}-regression.json"
          fi

          echo "DATA_DIR=${DATA_DIR}" >> "$GITHUB_ENV"
          echo "SHORT_COMMIT=${SHORT_COMMIT}" >> "$GITHUB_ENV"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rebuild index
        run: python3 dashboard/scripts/rebuild_index.py --data-dir data --output data/index.json

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./data
          destination_dir: data
          keep_files: true
