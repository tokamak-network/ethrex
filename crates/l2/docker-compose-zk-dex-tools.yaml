services:
  # ==========================================================================
  # Database Services
  # ==========================================================================
  redis-db:
    image: 'redis:alpine'
    container_name: zk-dex-tools-redis
    command: redis-server
    restart: unless-stopped

  db-init:
    image: postgres:17
    container_name: zk-dex-tools-db-init
    volumes:
      - zk-dex-tools-blockscout-db:/var/lib/postgresql/data
    entrypoint:
      - sh
      - -c
      - |
        chown -R 2000:2000 /var/lib/postgresql/data

  db:
    image: postgres:17
    user: 2000:2000
    shm_size: 256m
    restart: unless-stopped
    container_name: zk-dex-tools-db
    command: postgres -c 'max_connections=200' -c 'client_connection_check_interval=60000'
    environment:
      POSTGRES_DB: 'blockscout'
      POSTGRES_USER: 'blockscout'
      POSTGRES_PASSWORD: 'ceWb1MeLBEeOIfk65gU8EjF8'
    ports:
      - target: 5432
        published: 7432
    volumes:
      - zk-dex-tools-blockscout-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -d blockscout"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      db-init:
        condition: service_completed_successfully

  # ==========================================================================
  # L1 Blockscout
  # ==========================================================================
  backend-l1:
    image: ghcr.io/lambdaclass/blockscout-private:9.2.2.commit.763c41da
    pull_policy: always
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis-db:
        condition: service_started
    links:
      - db:database
    stop_grace_period: 5m
    container_name: zk-dex-tools-backend-l1
    command: sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      ETHEREUM_JSONRPC_HTTP_URL: http://host.docker.internal:8545/
      ETHEREUM_JSONRPC_TRACE_URL: http://host.docker.internal:8545/
      CHAIN_ID: '9'
      ETHEREUM_JSONRPC_VARIANT: geth
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: true
      INDEXER_DISABLE_EMPTY_BLOCKS_SANITIZER: true
      DISABLE_FILE_LOGGING: false
      DATABASE_URL: postgresql://blockscout:ceWb1MeLBEeOIfk65gU8EjF8@db:5432/blockscout_l1
      ETHEREUM_JSONRPC_TRANSPORT: http
      ETHEREUM_JSONRPC_DISABLE_ARCHIVE_BALANCES: false
      SECRET_KEY_BASE: 56NtB48ear7+wMSf0IQuWDAAazhpb31qyc7GiyspBP2vh7t5zlCsF5QDv76chXeN
      PORT: 4000
      COIN_NAME: Ether
      COIN: ETH
      DISABLE_MARKET: true
      POOL_SIZE: 80
      POOL_SIZE_API: 10
      ECTO_USE_SSL: false
      HEART_BEAT_TIMEOUT: 30
      RELEASE_LINK: "prague,default"
      ADMIN_PANEL_ENABLED: false
      API_V1_READ_METHODS_DISABLED: false
      API_V1_WRITE_METHODS_DISABLED: false
      TXS_STATS_DAYS_TO_COMPILE_AT_INIT: 10
      COIN_BALANCE_HISTORY_DAYS: 90
      RE_CAPTCHA_DISABLED: false
      MICROSERVICE_SC_VERIFIER_TYPE: eth_bytecode_db
      MICROSERVICE_VISUALIZE_SOL2UML_ENABLED: false
      MICROSERVICE_SIG_PROVIDER_ENABLED: false
      MICROSERVICE_ACCOUNT_ABSTRACTION_ENABLED: false
      DECODE_NOT_A_CONTRACT_CALLS: true
      ACCOUNT_ENABLED: false
      ACCOUNT_REDIS_URL: redis://redis-db:6379/1
      NFT_MEDIA_HANDLER_ENABLED: false
      NFT_MEDIA_HANDLER_REMOTE_DISPATCHER_NODE_MODE_ENABLED: false
      RELEASE_NODE: producer@172.18.0.4
      RELEASE_DISTRIBUTION: name
      RELEASE_COOKIE: secret_cookie

  frontend-l1:
    image: ghcr.io/lambdaclass/frontend-private:test
    platform: linux/amd64
    container_name: zk-dex-tools-frontend-l1
    depends_on:
      - backend-l1
    environment:
      NEXT_PUBLIC_API_HOST: localhost:8083
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_NETWORK_NAME: TokamakAppL2 ZK-DEX L1
      NEXT_PUBLIC_NETWORK_SHORT_NAME: TokamakAppL2 ZK-DEX L1
      NEXT_PUBLIC_NETWORK_ID: 9
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: Ether
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_API_BASE_PATH: /
      NEXT_PUBLIC_APP_HOST: localhost:8083
      NEXT_PUBLIC_APP_PROTOCOL: http
      NEXT_PUBLIC_HOMEPAGE_CHARTS: "['daily_txs']"
      NEXT_PUBLIC_IS_TESTNET: true
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: ws
      NEXT_PUBLIC_API_SPEC_URL: https://raw.githubusercontent.com/blockscout/blockscout-api-v2-swagger/main/swagger.yaml
      NEXT_PUBLIC_AD_BANNER_PROVIDER: none
      NEXT_PUBLIC_AD_TEXT_PROVIDER: none
      NEXT_PUBLIC_MARKETPLACE_ENABLED: false
      NEXT_PUBLIC_PROMOTE_BLOCKSCOUT_IN_TITLE: false

  # ==========================================================================
  # L2 Blockscout
  # ==========================================================================
  backend-l2:
    image: ghcr.io/lambdaclass/blockscout-private:9.2.2.commit.763c41da
    pull_policy: always
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis-db:
        condition: service_started
    links:
      - db:database
    stop_grace_period: 5m
    container_name: zk-dex-tools-backend-l2
    command: sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      ETHEREUM_JSONRPC_HTTP_URL: http://host.docker.internal:1729/
      ETHEREUM_JSONRPC_TRACE_URL: http://host.docker.internal:1729/
      CHAIN_ID: '65536999'
      ETHEREUM_JSONRPC_VARIANT: geth
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: true
      INDEXER_DISABLE_EMPTY_BLOCKS_SANITIZER: true
      DISABLE_FILE_LOGGING: false
      DATABASE_URL: postgresql://blockscout:ceWb1MeLBEeOIfk65gU8EjF8@db:5432/blockscout_l2
      ETHEREUM_JSONRPC_TRANSPORT: http
      ETHEREUM_JSONRPC_DISABLE_ARCHIVE_BALANCES: false
      SECRET_KEY_BASE: 56NtB48ear7+wMSf0IQuWDAAazhpb31qyc7GiyspBP2vh7t5zlCsF5QDv76chXeN
      PORT: 4000
      COIN_NAME: Ether
      COIN: ETH
      DISABLE_MARKET: true
      POOL_SIZE: 80
      POOL_SIZE_API: 10
      ECTO_USE_SSL: false
      HEART_BEAT_TIMEOUT: 30
      RELEASE_LINK: "prague,default"
      ADMIN_PANEL_ENABLED: false
      API_V1_READ_METHODS_DISABLED: false
      API_V1_WRITE_METHODS_DISABLED: false
      TXS_STATS_DAYS_TO_COMPILE_AT_INIT: 10
      COIN_BALANCE_HISTORY_DAYS: 90
      RE_CAPTCHA_DISABLED: false
      MICROSERVICE_SC_VERIFIER_TYPE: eth_bytecode_db
      MICROSERVICE_VISUALIZE_SOL2UML_ENABLED: false
      MICROSERVICE_SIG_PROVIDER_ENABLED: false
      MICROSERVICE_ACCOUNT_ABSTRACTION_ENABLED: false
      DECODE_NOT_A_CONTRACT_CALLS: true
      ACCOUNT_ENABLED: false
      ACCOUNT_REDIS_URL: redis://redis-db:6379/2
      NFT_MEDIA_HANDLER_ENABLED: false
      NFT_MEDIA_HANDLER_REMOTE_DISPATCHER_NODE_MODE_ENABLED: false
      RELEASE_NODE: producer@172.18.0.5
      RELEASE_DISTRIBUTION: name
      RELEASE_COOKIE: secret_cookie

  frontend-l2:
    image: ghcr.io/lambdaclass/frontend-private:test
    platform: linux/amd64
    container_name: zk-dex-tools-frontend-l2
    depends_on:
      - backend-l2
    environment:
      NEXT_PUBLIC_API_HOST: localhost:8082
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_NETWORK_NAME: TokamakAppL2 ZK-DEX L2
      NEXT_PUBLIC_NETWORK_SHORT_NAME: TokamakAppL2 ZK-DEX L2
      NEXT_PUBLIC_NETWORK_ID: 65536999
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: Ether
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_API_BASE_PATH: /
      NEXT_PUBLIC_APP_HOST: localhost:8082
      NEXT_PUBLIC_APP_PROTOCOL: http
      NEXT_PUBLIC_HOMEPAGE_CHARTS: "['daily_txs']"
      NEXT_PUBLIC_IS_TESTNET: true
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: ws
      NEXT_PUBLIC_API_SPEC_URL: https://raw.githubusercontent.com/blockscout/blockscout-api-v2-swagger/main/swagger.yaml
      NEXT_PUBLIC_AD_BANNER_PROVIDER: none
      NEXT_PUBLIC_AD_TEXT_PROVIDER: none
      NEXT_PUBLIC_MARKETPLACE_ENABLED: false
      NEXT_PUBLIC_PROMOTE_BLOCKSCOUT_IN_TITLE: false

  # ==========================================================================
  # Nginx Proxy (Blockscout routing)
  # ==========================================================================
  proxy:
    image: nginx
    container_name: zk-dex-tools-proxy
    depends_on:
      - backend-l1
      - frontend-l1
      - backend-l2
      - frontend-l2
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    configs:
      - source: nginx_conf
        target: /etc/nginx/conf.d/default.conf
    restart: unless-stopped
    ports:
      - target: 8082
        published: 8082
      - target: 8083
        published: 8083

  # ==========================================================================
  # Function Selectors (insert known ABI into Blockscout DB)
  # ==========================================================================
  function-selectors:
    image: postgres:17
    container_name: zk-dex-tools-selectors
    depends_on:
      - backend-l1
      - backend-l2
    env_file:
      - .zk-dex-deployed.env
    restart: "no"
    entrypoint:
      - sh
      - -c
      - |
        echo "Waiting for Blockscout databases to be ready..."
        sleep 30

        echo "Inserting L1 function selectors..."

        psql postgresql://blockscout:ceWb1MeLBEeOIfk65gU8EjF8@db:5432/blockscout_l1 <<'EOF'
        INSERT INTO contract_methods (identifier, type, inserted_at, updated_at, abi) VALUES
          (((x'3db97de8')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"commitBatch","inputs":[{"name":"batchNumber","type":"uint256"},{"name":"newStateRoot","type":"bytes32"},{"name":"withdrawalsLogsMerkleRoot","type":"bytes32"},{"name":"processedPrivilegedTransactionsRollingHash","type":"bytes32"},{"name":"lastBlockHash","type":"bytes32"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'1ebed24e')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"verifyBatch","inputs":[{"name":"batchNumber","type":"uint256"},{"name":"risc0BlockProof","type":"bytes"},{"name":"risc0Journal","type":"bytes"},{"name":"sp1PublicValues","type":"bytes"},{"name":"sp1ProofBytes","type":"bytes"},{"name":"tdxPublicValues","type":"bytes"},{"name":"tdxSignature","type":"bytes"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'c285ae54')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"verifyBatchesAligned","inputs":[{"name":"firstBatchNumber","type":"uint256"},{"name":"publicInputsList","type":"bytes[]"},{"name":"sp1MerkleProofsList","type":"bytes32[][]"},{"name":"risc0MerkleProofsList","type":"bytes32[][]"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'972217da')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"claimWithdrawal","inputs":[{"name":"claimedAmount","type":"uint256"},{"name":"withdrawalBatchNumber","type":"uint256"},{"name":"withdrawalMessageId","type":"uint256"},{"name":"withdrawalProof","type":"bytes32[]"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'f340fa01')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"deposit","inputs":[{"name":"l2Recipient","type":"address"}],"outputs":[],"stateMutability":"payable"}'),
          (((x'9943b6e0')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"depositERC20","inputs":[{"name":"tokenL1","type":"address"},{"name":"tokenL2","type":"address"},{"name":"destination","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'327091d3')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"sendToL2","inputs":[{"name":"sendValues","type":"tuple","components":[{"name":"to","type":"address"},{"name":"gasLimit","type":"uint256"},{"name":"value","type":"uint256"},{"name":"data","type":"bytes"}]}],"outputs":[],"stateMutability":"nonpayable"}')
        ON CONFLICT DO NOTHING;
        EOF

        echo "Inserting L2 function selectors..."

        psql postgresql://blockscout:ceWb1MeLBEeOIfk65gU8EjF8@db:5432/blockscout_l2 <<'EOF'
        INSERT INTO contract_methods (identifier, type, inserted_at, updated_at, abi) VALUES
          (((x'51cff8d9')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"withdraw","inputs":[{"name":"_receiverOnL1","type":"address"}],"outputs":[],"stateMutability":"payable"}'),
          (((x'd23061db')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"withdrawERC20","inputs":[{"name":"tokenL1","type":"address"},{"name":"tokenL2","type":"address"},{"name":"destination","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'b0f4d395')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"mintETH","inputs":[{"name":"to","type":"address"}],"outputs":[],"stateMutability":"payable"}'),
          (((x'79204fe0')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"mintERC20","inputs":[{"name":"tokenL1","type":"address"},{"name":"tokenL2","type":"address"},{"name":"destination","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable"}'),
          (((x'00cffbe5')::bit(32))::int, '', NOW(), NOW(), '{"type":"function","name":"sendMessageToL1","inputs":[{"name":"data","type":"bytes32"}],"outputs":[],"stateMutability":"nonpayable"}')
        ON CONFLICT DO NOTHING;
        EOF

        echo "Inserting address names (dynamic from deployed addresses)..."

        # Extract addresses without 0x prefix for PostgreSQL decode()
        BRIDGE_HEX=$$(echo "$$ETHREX_WATCHER_BRIDGE_ADDRESS" | sed 's/^0x//')
        PROPOSER_HEX=$$(echo "$$ETHREX_COMMITTER_ON_CHAIN_PROPOSER_ADDRESS" | sed 's/^0x//')

        psql postgresql://blockscout:ceWb1MeLBEeOIfk65gU8EjF8@db:5432/blockscout_l1 <<EOF
        INSERT INTO address_names (address_hash, name, inserted_at, updated_at) VALUES
          (decode('$${PROPOSER_HEX}', 'hex'), 'OnChainProposer', NOW(), NOW()),
          (decode('$${BRIDGE_HEX}', 'hex'), 'CommonBridge', NOW(), NOW())
        ON CONFLICT DO NOTHING;
        EOF

        psql postgresql://blockscout:ceWb1MeLBEeOIfk65gU8EjF8@db:5432/blockscout_l2 <<'EOF'
        INSERT INTO address_names (address_hash, name, inserted_at, updated_at) VALUES
          (decode('000000000000000000000000000000000000FFFF', 'hex'), 'CommonBridgeL2', NOW(), NOW())
        ON CONFLICT DO NOTHING;
        EOF

        echo "Function selectors and address names inserted."
        echo "  Bridge: $$ETHREX_WATCHER_BRIDGE_ADDRESS"
        echo "  Proposer: $$ETHREX_COMMITTER_ON_CHAIN_PROPOSER_ADDRESS"

  # ==========================================================================
  # Bridge UI + Dashboard
  # ==========================================================================
  bridge-ui:
    build:
      context: ./tooling/bridge
      dockerfile: Dockerfile
    container_name: zk-dex-tools-bridge-ui
    restart: unless-stopped
    env_file:
      - .zk-dex-deployed.env
    ports:
      - target: 80
        published: 3000

# ==========================================================================
# Nginx Config
# ==========================================================================
configs:
  nginx_conf:
    content: |
      map $$http_upgrade $$connection_upgrade {
        default upgrade;
        ''      close;
      }

      # L2 Blockscout
      server {
          listen 8082;
          server_name localhost;
          proxy_http_version 1.1;

          location ~ ^/(api(?!-docs$$)|socket|sitemap.xml|auth/auth0|auth/auth0/callback|auth/logout) {
              proxy_pass            http://backend-l2:4000;
              proxy_http_version    1.1;
              proxy_set_header      Host "$$host";
              proxy_set_header      X-Real-IP "$$remote_addr";
              proxy_set_header      X-Forwarded-For "$$proxy_add_x_forwarded_for";
              proxy_set_header      X-Forwarded-Proto "$$scheme";
              proxy_set_header      Upgrade "$$http_upgrade";
              proxy_set_header      Connection $$connection_upgrade;
              proxy_cache_bypass    $$http_upgrade;
          }

          location / {
              proxy_pass            http://frontend-l2:3000;
              proxy_http_version    1.1;
              proxy_set_header      Host "$$host";
              proxy_set_header      X-Real-IP "$$remote_addr";
              proxy_set_header      X-Forwarded-For "$$proxy_add_x_forwarded_for";
              proxy_set_header      X-Forwarded-Proto "$$scheme";
              proxy_set_header      Upgrade "$$http_upgrade";
              proxy_set_header      Connection $$connection_upgrade;
              proxy_cache_bypass    $$http_upgrade;
          }
      }

      # L1 Blockscout
      server {
          listen 8083;
          server_name localhost;
          proxy_http_version 1.1;

          location ~ ^/(api(?!-docs$$)|socket|sitemap.xml|auth/auth0|auth/auth0/callback|auth/logout) {
              proxy_pass            http://backend-l1:4000;
              proxy_http_version    1.1;
              proxy_set_header      Host "$$host";
              proxy_set_header      X-Real-IP "$$remote_addr";
              proxy_set_header      X-Forwarded-For "$$proxy_add_x_forwarded_for";
              proxy_set_header      X-Forwarded-Proto "$$scheme";
              proxy_set_header      Upgrade "$$http_upgrade";
              proxy_set_header      Connection $$connection_upgrade;
              proxy_cache_bypass    $$http_upgrade;
          }

          location / {
              proxy_pass            http://frontend-l1:3000;
              proxy_http_version    1.1;
              proxy_set_header      Host "$$host";
              proxy_set_header      X-Real-IP "$$remote_addr";
              proxy_set_header      X-Forwarded-For "$$proxy_add_x_forwarded_for";
              proxy_set_header      X-Forwarded-Proto "$$scheme";
              proxy_set_header      Upgrade "$$http_upgrade";
              proxy_set_header      Connection $$connection_upgrade;
              proxy_cache_bypass    $$http_upgrade;
          }
      }

volumes:
  zk-dex-tools-blockscout-db:
