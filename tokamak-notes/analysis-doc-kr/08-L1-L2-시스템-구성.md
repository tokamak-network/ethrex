# 08. L1 + L2 전체 시스템 구성

> L2 모드 실행 시 시작되는 모든 컴포넌트와 데이터 흐름 분석

---

## 1. 전체 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           이더리움 L1 네트워크                                │
│                                                                             │
│  ┌─────────────────┐     ┌──────────────────────────────────────────┐       │
│  │  ethrex L1 Node │     │  L1 스마트 컨트랙트                      │       │
│  │  (--dev 모드)    │     │                                          │       │
│  │                 │     │  ┌────────────────┐ ┌──────────────┐     │       │
│  │  - Block 실행   │     │  │OnChainProposer │ │ CommonBridge │     │       │
│  │  - 상태 관리     │     │  │(배치 커밋/검증) │ │ (입출금 브릿지)│     │       │
│  │  - RPC :8545    │     │  └────────────────┘ └──────────────┘     │       │
│  │  - DevP2P      │     │  ┌────────────────┐ ┌──────────────┐     │       │
│  └─────────────────┘     │  │    Router      │ │   Timelock   │     │       │
│                          │  │ (멀티체인 라우팅)│ │  (업그레이드)  │     │       │
│                          │  └────────────────┘ └──────────────┘     │       │
│                          └──────────────────────────────────────────┘       │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
          ┌─────────────────────────┼──────────────────────────┐
          │ L1 <-> L2 통신          │                          │
          │                         │                          │
     L1Watcher              L1Committer              L1ProofSender
     (L1->L2)               (L2->L1)                 (증명->L1)
     입금/메시지 감시         배치 커밋 전송             검증된 증명 제출
          │                         │                          │
          v                         ^                          ^
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ethrex L2 시퀀서 노드 (단일 프로세스)                  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    시퀀서 컴포넌트 (GenServer 액터 모델)               │   │
│  │                                                                      │   │
│  │  ┌─────────────┐  ┌──────────────┐  ┌────────────────────────┐      │   │
│  │  │BlockProducer│  │ L1Committer  │  │   ProofCoordinator     │      │   │
│  │  │             │  │  (= 배처)     │  │                        │      │   │
│  │  │ - 멤풀에서   │  │              │  │ - TCP 서버 (:3900)      │      │   │
│  │  │   TX 수집   │  │ - L2 블록들을 │  │ - 외부 프루버에         │      │   │
│  │  │ - 블록 생성  │  │   배치로 묶음 │  │   작업 할당            │      │   │
│  │  │ - 5초 간격   │  │ - Blob/Callda│  │ - 증명 수신/저장        │      │   │
│  │  │   (설정가능) │  │   ta로 인코딩 │  │ - 다중 프루버 타입 관리  │      │   │
│  │  │ - 실행+검증  │  │ - L1에 커밋TX │  │   (SP1,RISC0,TDX...)  │      │   │
│  │  └─────────────┘  └──────────────┘  └──────────┬─────────────┘      │   │
│  │                                                 │ TCP                │   │
│  │  ┌─────────────┐  ┌──────────────┐  ┌──────────┘                    │   │
│  │  │ L1Watcher   │  │L1ProofSender │  │                               │   │
│  │  │             │  │              │  │  ┌──────────────┐              │   │
│  │  │ - L1 블록   │  │ - 완성된 증명 │  │  │ StateUpdater │              │   │
│  │  │   모니터링   │  │   L1에 전송   │  │  │              │              │   │
│  │  │ - 입금 TX   │  │ - 가스 범핑   │  │  │ - L1 검증 상태│              │   │
│  │  │   감지/처리  │  │   재시도 로직 │  │  │   모니터링    │              │   │
│  │  │ - L1 Fee    │  │              │  │  │ - 시퀀서 상태 │              │   │
│  │  │   업데이트   │  │              │  │  │   동기화      │              │   │
│  │  └─────────────┘  └──────────────┘  │  └──────────────┘              │   │
│  └─────────────────────────────────────┘────────────────────────────────┘   │
│                                                                             │
│  ┌───────────────────────────┐  ┌──────────────────┐  ┌──────────────────┐ │
│  │    L2 RPC API (:1729)     │  │  Admin Server    │  │ Metrics (선택)   │ │
│  │                           │  │                  │  │                  │ │
│  │ - eth_* (표준 이더리움)    │  │ - 시퀀서 제어     │  │ - Prometheus     │ │
│  │ - engine_* (Engine API)   │  │ - 컴포넌트 상태   │  │ - Grafana 대시보드│ │
│  │ - ethrex_* (L2 전용)      │  │ - Health check   │  │                  │ │
│  │ - debug_*, admin_*        │  │                  │  │                  │ │
│  └───────────────────────────┘  └──────────────────┘  └──────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         스토리지                                       │  │
│  │  ┌──────────────────────┐  ┌──────────────────────┐                   │  │
│  │  │ Store (RocksDB)      │  │ StoreRollup          │                   │  │
│  │  │ - 블록/트랜잭션/상태  │  │ - 배치 정보           │                   │  │
│  │  │ - Merkle Patricia    │  │ - 증명 데이터          │                   │  │
│  │  │   Trie               │  │ - L2 전용 메타데이터    │                   │  │
│  │  └──────────────────────┘  └──────────────────────┘                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │ TCP :3900
                                        v
┌─────────────────────────────────────────────────────────────────────────────┐
│                    프루버 (별도 프로세스, 자동 시작 아님!)                      │
│                                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────────┐  │
│  │  Exec Backend       │  │  SP1 Backend        │  │  RISC0 Backend     │  │
│  │  (테스트용, 증명없음) │  │  (Succinct SP1)     │  │  (RISC Zero)       │  │
│  └─────────────────────┘  └─────────────────────┘  └────────────────────┘  │
│  ┌─────────────────────┐  ┌─────────────────────┐                          │
│  │  Zisk Backend       │  │  OpenVM Backend     │                          │
│  └─────────────────────┘  └─────────────────────┘                          │
│                                                                             │
│  동작 방식:                                                                  │
│  1. ProofCoordinator에 TCP 연결                                              │
│  2. 증명할 배치 요청 (polling)                                                │
│  3. 배치 데이터 수신 -> ZK 증명 생성                                           │
│  4. 증명 결과를 ProofCoordinator에 반환                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Docker Compose 기반 서비스 구성

Docker Compose(`crates/l2/docker-compose.yaml`) 기준으로 **4개 서비스**가 순차적으로 시작된다:

| 순서 | 서비스 | 이미지 | 포트 | 역할 |
|------|--------|--------|------|------|
| 1 | `ethrex_l1` | `ethrex:main` | `:8545` | L1 이더리움 노드 (dev 모드) |
| 2 | `contract_deployer` | `ethrex:main-l2` | - | L1 컨트랙트 배포 후 종료 |
| 3 | `ethrex_l2` | `ethrex:main-l2` | `:1729`, `:3900` | L2 시퀀서 노드 |
| 4 | `ethrex_prover` | `ethrex:main-l2` | - | ZK 프루버 |

### 의존 관계

```
ethrex_l1  -->  contract_deployer  -->  ethrex_l2  -->  ethrex_prover
  (L1 노드)     (컨트랙트 배포)        (L2 시퀀서)      (증명 생성)
```

---

## 3. L2 시퀀서 초기화 순서

`cmd/ethrex/l2/initializers.rs`의 `init_l2()` 함수 기준:

```
1. Store 초기화 (RocksDB)
   └─ init_store(&datadir, genesis)

2. RollupStore 초기화 (InMemory 또는 SQL)
   └─ init_rollup_store(&rollup_store_dir)

3. FeeConfig 설정
   ├─ OperatorFeeConfig (운영자 수수료)
   └─ L1FeeConfig (L1 가스비 연동)

4. Blockchain 초기화
   └─ BlockchainType::L2(L2Config { fee_config })

5. 상태 복구
   └─ regenerate_state(&store, &rollup_store, &blockchain)

6. P2P 네트워크 (선택)
   ├─ PeerTable::spawn()
   ├─ RLPxInitiator::spawn()
   ├─ SyncManager::new()
   └─ init_network()

7. L2 RPC API
   └─ ethrex_l2_rpc::start_api(:1729)

8. Metrics (선택)
   └─ Prometheus 메트릭 서버

9. L2 시퀀서 시작
   └─ ethrex_l2::start_l2() → 6개 컴포넌트 spawn
```

---

## 4. 시퀀서 내부 컴포넌트 (GenServer 액터)

`crates/l2/sequencer/mod.rs`의 `start_l2()` 함수에서 spawn되는 컴포넌트:

| 컴포넌트 | 파일 | 역할 | 통신 방식 |
|----------|------|------|-----------|
| **L1Watcher** | `l1_watcher.rs` | L1 이벤트 감시 (입금, 메시지) | GenServer Cast |
| **L1Committer** | `l1_committer.rs` | 배치 생성 및 L1 커밋 (= 배처) | GenServer Cast/Call |
| **ProofCoordinator** | `proof_coordinator.rs` | 프루버에 작업 할당, 증명 수집 | TCP `:3900` |
| **L1ProofSender** | `l1_proof_sender.rs` | 검증된 증명을 L1에 전송 | GenServer Cast |
| **BlockProducer** | `block_producer.rs` | L2 블록 생성 (멤풀에서 TX 수집) | GenServer Cast/Call |
| **StateUpdater** | `state_updater.rs` | L1 검증 상태 모니터링, 파이널리티 추적 | GenServer Cast |

### 조건부 컴포넌트

| 컴포넌트 | 조건 | 역할 |
|----------|------|------|
| **BlockFetcher** | `cfg.based.enabled` | Based 모드에서 L1 블록 데이터 가져오기 |
| **L1ProofVerifier** | `cfg.aligned.aligned_mode` | Aligned Layer 증명 검증 |
| **MetricsGatherer** | `feature = "metrics"` | 메트릭 수집 |
| **EthrexMonitor** | `cfg.monitor.enabled` | TUI 모니터링 대시보드 |
| **AdminServer** | 항상 | 시퀀서 관리 API |

---

## 5. 프루버는 자동으로 시작되지 않는다

프루버는 **별도 프로세스**로 수동 실행해야 한다:

```bash
# 프루버 별도 시작
ethrex l2 prover --backend exec --proof-coordinators tcp://localhost:3900
```

### 프루버 동작 방식 (`crates/l2/prover/src/prover.rs`)

```
┌──────────┐         TCP          ┌──────────────────┐
│  Prover  │ ◄──── polling ────► │ ProofCoordinator │
│          │                      │   (TCP :3900)    │
│ 1. 연결   │                      │                  │
│ 2. 배치   │ ◄── 배치 데이터 ───  │ 3. 작업 할당     │
│    요청   │                      │                  │
│ 4. 증명   │ ──── 증명 결과 ───► │ 5. 증명 저장     │
│    생성   │                      │                  │
└──────────┘                      └──────────────────┘
```

지원 백엔드: `Exec`(테스트), `SP1`, `RISC0`, `Zisk`, `OpenVM`

---

## 6. 배처(Batcher) = L1Committer

**L1Committer가 배처 역할을 수행**한다 (`crates/l2/sequencer/l1_committer.rs`).

### 배칭 흐름

```
BlockProducer(블록 생성, 5초 간격)
        │
        v
L1Committer가 블록들을 수집
        │
        v
여러 블록을 하나의 Batch로 묶음 (기본 60초 주기)
        │
        v
Blob 또는 Calldata로 인코딩
        │
        v
L1 OnChainProposer.commitBatch() 호출
```

- **커밋 주기**: 기본 60초 (`COMMITTER_DEFAULT_WAKE_TIME_MS = 60_000`)
- **배치 가스 한도**: `batch_gas_limit` 설정으로 배치 크기 제한
- **트랜잭션 타입**: 롤업 모드 = EIP-4844 (블롭), 발리디움 모드 = EIP-1559

---

## 7. Dev 모드 실행 시 흐름

`ethrex l2 --dev` 명령어 실행 시 (`cmd/ethrex/l2/command.rs`):

```
1. DB 삭제
   ├─ remove_db(DB_ETHREX_DEV_L1)
   └─ remove_db(DB_ETHREX_DEV_L2)

2. L1 노드 시작 (dev 모드)
   └─ init_l1(Options::default_l1())

3. L1 컨트랙트 배포
   └─ deploy_l1_contracts(DeployerOptions::default())
       ├─ OnChainProposer
       ├─ CommonBridge
       ├─ Router
       └─ Timelock

4. L2 시퀀서 시작
   └─ init_l2(l2_options, log_filter_handler)
       └─ (위 초기화 순서 참고)
```

**하나의 프로세스**에서 L1 + 컨트랙트 배포 + L2 시퀀서가 모두 실행된다.

---

## 8. 전체 데이터 흐름 요약

```
사용자 TX --> L2 RPC(멤풀) --> BlockProducer(블록 생성, 5초)
                                    │
                            L1Committer(배치 묶음, 60초)
                                    │
                         L1 OnChainProposer.commitBatch()
                                    │
                     ProofCoordinator --> 프루버(증명 생성)
                                    │
                     L1ProofSender --> L1에 증명 제출
                                    │
                     StateUpdater(L1 검증 확인, 상태 Finalize)
```

---

## 9. 코드 참조

| 파일 | 설명 |
|------|------|
| `cmd/ethrex/l2/command.rs` | L2 명령어 처리, dev 모드 흐름 |
| `cmd/ethrex/l2/initializers.rs` | `init_l2()` - L2 전체 초기화 |
| `crates/l2/sequencer/mod.rs` | `start_l2()` - 시퀀서 컴포넌트 spawn |
| `crates/l2/sequencer/block_producer.rs` | 블록 생성 액터 |
| `crates/l2/sequencer/l1_committer.rs` | 배치 커밋 (배처) |
| `crates/l2/sequencer/proof_coordinator.rs` | 프루버 작업 할당 TCP 서버 |
| `crates/l2/sequencer/l1_proof_sender.rs` | 증명 L1 전송 |
| `crates/l2/sequencer/l1_watcher.rs` | L1 이벤트 감시 |
| `crates/l2/sequencer/state_updater.rs` | L1 검증 상태 추적 |
| `crates/l2/prover/src/prover.rs` | 프루버 메인 루프 |
| `crates/l2/docker-compose.yaml` | Docker 서비스 구성 |

---

*분석일: 2026-02-21*
