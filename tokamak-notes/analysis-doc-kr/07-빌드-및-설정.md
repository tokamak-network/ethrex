# Ethrex 프로젝트 분석 - 빌드 및 설정

## 1. Rust 툴체인

### 1.1 기본 설정

| 항목 | 값 |
|------|-----|
| Rust 버전 | 1.90.0 |
| 에디션 | 2024 |
| 릴리스 최적화 | opt-level 3 |
| LTO | thin (빠른 링킹) |
| Codegen units | 1 (더 나은 최적화) |

### 1.2 린트 설정

프로젝트 전체에 적용되는 엄격한 린트 규칙:

| 린트 | 수준 | 설명 |
|------|------|------|
| `unwrap_used` | deny | `unwrap()` 사용 금지 |
| `expect_used` | deny | `expect()` 사용 금지 |
| `panic` | deny | `panic!` 사용 금지 (일부 크레이트) |
| `as_conversions` | deny | 명시적 캐스팅 지양 |
| `arithmetic_side_effects` | deny | 산술 부작용 주의 |
| `redundant_clone` | warn | 불필요한 클론 경고 |

## 2. Makefile 빌드 타깃

### 2.1 빌드

| 타깃 | 설명 |
|------|------|
| `make build` | 전체 워크스페이스 빌드 |
| `make build-image` | Docker 이미지 빌드 |

### 2.2 테스트

| 타깃 | 설명 |
|------|------|
| `make test` | 단위 테스트 실행 |
| `make run-hive` | Hive 테스트 스위트 실행 |
| `make run-hive-eels` | EELS 테스트 실행 |
| `make lint` | Clippy 린터 실행 |

### 2.3 개발

| 타깃 | 설명 |
|------|------|
| `make dev` | 개발 모드 (인메모리 DB) 실행 |
| `make localnet` | Kurtosis로 로컬 네트워크 시작 |
| `make load-test` | 부하 테스트 실행 |
| `make start-node-with-flamegraph` | Flamegraph 프로파일링 |

### 2.4 유틸리티

| 타깃 | 설명 |
|------|------|
| `make import` | 블록 가져오기 |
| `make export` | 블록 내보내기 |
| `make sort-genesis-files` | 제네시스 파일 정렬 |
| `make docs` | 문서 생성 |
| `make docs-serve` | 문서 서빙 |

## 3. 기능 플래그 (Feature Flags)

### 3.1 핵심 기능

| 플래그 | 설명 | 기본값 |
|--------|------|--------|
| `l2` | L2 롤업 기능 활성화 | 비활성 |
| `c-kzg` | KZG 커밋먼트 (C 구현) | 비활성 |
| `metrics` | Prometheus 메트릭 수집 | 비활성 |
| `dev` | 개발 모드 기능 | 비활성 |

### 3.2 프루버 백엔드

| 플래그 | 설명 |
|--------|------|
| `sp1` | SP1 프루버 백엔드 |
| `risc0` | RISC Zero 프루버 백엔드 |
| `zisk` | Zisk 프루버 백엔드 |
| `openvm` | OpenVM 프루버 백엔드 |

### 3.3 기타

| 플래그 | 설명 |
|--------|------|
| `gpu` | GPU 가속 |
| `experimental-discv5` | DiscV5 노드 디스커버리 |

## 4. 네트워크 설정

### 4.1 지원 네트워크 및 부트노드

각 네트워크의 설정 파일 위치: `cmd/ethrex/networks/`

```
networks/
├── mainnet/
│   ├── bootnodes.json    # 메인넷 부트노드
│   └── genesis.json      # 메인넷 제네시스
├── sepolia/
│   ├── bootnodes.json
│   └── genesis.json
├── holesky/
│   ├── bootnodes.json
│   └── genesis.json
└── hoodi/
    ├── bootnodes.json
    └── genesis.json
```

### 4.2 제네시스 설정

제네시스 파일에 포함되는 주요 설정:

```json
{
    "config": {
        "chainId": 1,
        "homesteadBlock": 0,
        "eip150Block": 0,
        "eip155Block": 0,
        "eip158Block": 0,
        "byzantiumBlock": 0,
        "constantinopleBlock": 0,
        "petersburgBlock": 0,
        "istanbulBlock": 0,
        "berlinBlock": 0,
        "londonBlock": 0,
        "terminalTotalDifficulty": "...",
        "shanghaiTime": "...",
        "cancunTime": "...",
        "pragueTime": "..."
    },
    "difficulty": "0x1",
    "gasLimit": "0x1C9C380",
    "alloc": { ... }
}
```

## 5. CLI 설정 옵션

### 5.1 노드 설정

| 옵션 | 기본값 | 설명 |
|------|--------|------|
| `--network` | 없음 | 네트워크 선택 (mainnet, sepolia 등) |
| `--datadir` | `~/.ethrex` | 데이터 디렉토리 |
| `--syncmode` | `snap` | 동기화 모드 (full, snap) |
| `--dev` | false | 개발 모드 |

### 5.2 RPC 설정

| 옵션 | 기본값 | 설명 |
|------|--------|------|
| `--http.addr` | `0.0.0.0` | HTTP RPC 주소 |
| `--http.port` | `8545` | HTTP RPC 포트 |
| `--ws.addr` | `0.0.0.0` | WebSocket 주소 |
| `--ws.port` | `8546` | WebSocket 포트 |
| `--authrpc.addr` | `0.0.0.0` | Auth RPC 주소 |
| `--authrpc.port` | `8551` | Auth RPC 포트 |
| `--authrpc.jwtsecret` | - | JWT 비밀키 파일 경로 |

### 5.3 P2P 설정

| 옵션 | 기본값 | 설명 |
|------|--------|------|
| `--p2p.addr` | `0.0.0.0` | P2P 리스닝 주소 |
| `--p2p.port` | `30303` | P2P 리스닝 포트 |
| `--discovery.port` | `30303` | 디스커버리 UDP 포트 |
| `--bootnodes` | 네트워크별 | 부트노드 목록 |
| `--target-peers` | 50 | 목표 피어 수 |
| `--lookup-interval` | 30 | 피어 탐색 간격 (초) |

### 5.4 블록 빌딩 설정

| 옵션 | 기본값 | 설명 |
|------|--------|------|
| `--extra-data` | - | 블록 추가 데이터 |
| `--gas-limit` | 30,000,000 | 블록 가스 리밋 |
| `--max-blobs-per-block` | 포크별 | 블록당 최대 블롭 수 |

### 5.5 로깅 설정

| 옵션 | 기본값 | 설명 |
|------|--------|------|
| `--log.level` | `info` | 로그 수준 |
| `--log.color` | true | 컬러 출력 |
| `--log.dir` | - | 로그 파일 디렉토리 |
| `--metrics.addr` | - | 메트릭 주소 |
| `--metrics` | false | 메트릭 활성화 |

## 6. L2 설정

### 6.1 시퀀서 설정 (SequencerConfig)

```rust
SequencerConfig {
    // 블록 프로듀서
    block_producer: BlockProducerConfig {
        block_time_ms: u64,           // 블록 생성 간격
        gas_limit: u64,                // 가스 리밋
        coinbase: Address,             // 코인베이스 주소
        elasticity_multiplier: u64,    // 탄력성 승수
    },

    // 커미터
    committer: CommitterConfig {
        batch_gas_limit: u64,          // 배치 가스 리밋
        commit_interval_ms: u64,       // 커밋 간격
        wait_time_ms: u64,             // 대기 시간
    },

    // L1 워처
    l1_watcher: L1WatcherConfig {
        max_block_step: U256,          // 스캔당 최대 블록
        check_interval: u64,           // 스캔 간격
        l1_block_delay: u64,           // 블록 처리 지연
        bridge_address: Address,       // 브릿지 주소
        router_address: Address,       // 라우터 주소
    },

    // 증명 조정기
    proof_coordinator: ProofCoordinatorConfig {
        proving_time_ms: u64,          // 증명 시간 제한
    },

    // 이더리움 설정
    eth: EthConfig {
        l1_rpc_url: Url,               // L1 RPC URL
        retry_count: u32,              // 재시도 횟수
    },
}
```

## 7. Docker 설정

### 7.1 Dockerfile

```dockerfile
# 다단계 빌드
FROM rust:1.90.0 AS builder
# 빌드 단계

FROM debian:bookworm-slim
# 실행 단계
```

### 7.2 Docker Compose 파일

| 파일 | 설명 |
|------|------|
| `docker-compose.yaml` | 기본 L1 노드 |
| `crates/l2/docker-compose.yaml` | L2 시퀀서 |
| `crates/l2/docker-compose-l2-tdx.yaml` | L2 + TDX |
| `crates/l2/docker-compose-l2-web3signer.yaml` | L2 + Web3Signer |
| `metrics/docker-compose-metrics.yaml` | 메트릭 스택 |

## 8. 메트릭 및 모니터링

### 8.1 Prometheus + Grafana 스택

```
metrics/
├── docker-compose-metrics.yaml
├── provisioning/
│   ├── grafana/
│   │   ├── alerting/          # 알림 설정
│   │   ├── dashboards/        # 대시보드 정의
│   │   └── datasources/       # 데이터소스 설정
│   ├── prometheus/
│   │   ├── prometheus_l1_dev.yaml
│   │   ├── prometheus_l1_sync_docker.yaml
│   │   └── prometheus_l2.yaml
│   └── promtail/
│       └── promtail.yaml      # 로그 수집
```

### 8.2 대시보드

| 대시보드 | 설명 |
|----------|------|
| `ethrex_l1_perf.json` | L1 성능 메트릭 |
| `ethrex_comparison.json` | 클라이언트 비교 |
| `infra_dashboard.json` | 인프라 모니터링 |
| `tx_dashboard.json` | 트랜잭션 모니터링 |
| `l2_overview.json` | L2 개요 |
| `ethereum_metrics_exporter.json` | 이더리움 메트릭 |

## 9. 테스트 인프라

### 9.1 테스트 구조

```
test/
├── src/lib.rs                 # 테스트 유틸리티
└── tests/
    ├── blockchain/            # 블록체인 테스트
    │   ├── mempool_tests.rs
    │   └── smoke_tests.rs
    ├── common/                # 공통 유틸리티 테스트
    ├── crypto/                # 암호화 테스트
    ├── l2/                    # L2 통합 테스트
    ├── levm/                  # LEVM 테스트
    ├── p2p/                   # P2P 테스트
    ├── rlp/                   # RLP 테스트
    ├── rpc/                   # RPC 테스트
    ├── storage/               # 스토리지 테스트
    └── trie/                  # 트라이 테스트
```

### 9.2 외부 테스트 도구

| 도구 | 설명 |
|------|------|
| **EF Tests** | 이더리움 파운데이션 공식 테스트 |
| **Hive** | 이더리움 클라이언트 호환성 테스트 |
| **Assertoor** | 네트워크 안정성 테스트 |
| **Kurtosis** | 로컬 네트워크 테스트 |

### 9.3 EF 테스트

```
tooling/ef_tests/
├── blockchain/       # 블록체인 EF 테스트
├── state/            # 상태 EF 테스트
└── state_v2/         # 상태 EF 테스트 v2
```

### 9.4 벤치마크

```
benches/
└── benches/
    └── build_block_benchmark.rs   # 블록 빌딩 벤치마크

crates/vm/levm/bench/
└── revm_comparison/               # LEVM vs REVM 성능 비교
    ├── contracts/                 # 벤치마크 컨트랙트
    └── src/                       # 벤치마크 코드
```

## 10. CI/CD 파이프라인

### 10.1 GitHub Actions 워크플로우

| 워크플로우 | 트리거 | 설명 |
|-----------|--------|------|
| `pr-main_l1.yaml` | PR | L1 테스트 및 린트 |
| `pr-main_levm.yaml` | PR | LEVM 테스트 |
| `pr-main_l2.yaml` | PR | L2 테스트 |
| `pr-main_l2_prover.yaml` | PR | L2 프루버 테스트 |
| `pr_perf_levm.yaml` | PR | LEVM 성능 테스트 |
| `pr_perf_blocks_exec.yaml` | PR | 블록 실행 성능 |
| `daily_hive_report.yaml` | 매일 | Hive 일일 리포트 |
| `daily_loc_report.yaml` | 매일 | LOC 일일 리포트 |
| `daily_snapsync.yaml` | 매일 | 스냅 싱크 일일 테스트 |
| `tag_release.yaml` | 태그 | 릴리스 빌드 |

### 10.2 PR 자동화

| 워크플로우 | 설명 |
|-----------|------|
| `pr_ai_review.yaml` | AI 코드 리뷰 |
| `pr_github_metadata.yaml` | PR 메타데이터 설정 |
| `pr_lint_gha.yaml` | GitHub Actions 린트 |
| `pr_lint_license.yaml` | 라이선스 검사 |
| `pr_lint_pr_title.yml` | PR 타이틀 검사 |
| `pr_loc.yaml` | 코드 줄 수 통계 |

## 11. 로드맵 하이라이트

### 11.1 실행 최적화 (우선순위 0-1)

- 메모리 리사이즈 시 제로 초기화 건너뛰기
- 핫 옵코드 인라이닝
- EXTCODESIZE에서 전체 바이트코드 로드 없이 처리
- PGO/BOLT 프로파일링

### 11.2 I/O 최적화 (우선순위 0)

- RocksDB 블록 캐시 및 로우 캐시
- 파티션된 필터와 2단계 인덱스
- 메모리 매핑 읽기
- 트라이 순회 시 Multiget

### 11.3 RPC 최적화 (우선순위 0-1)

- 병렬 트랜잭션 루트 계산
- 불필요한 페이로드/파라미터 클론 제거
- String 대신 Bytes 사용

### 11.4 새 기능 (우선순위 1-2)

- DiscV5 지원
- Sparse Blobpool (EIP-8070)
- 아카이브 노드 모드
- IPv6 지원

### 11.5 L2/ZK (우선순위 1-2)

- Zisk 통합
- Based 롤업 지원
- 개선된 프루버 API

## 12. 구동 가이드

### 12.1 하드웨어 요구사항

| 네트워크 | 디스크 (최소) | 디스크 (권장) | RAM (최소) | RAM (권장) |
|---------|-------------|-------------|-----------|-----------|
| **Mainnet** | 500 GB | 1 TB | 32 GB | 64 GB |
| **Sepolia** | 250 GB | 400 GB | 32 GB | 64 GB |
| **Hoodi** | 60 GB | 100 GB | 32 GB | 64 GB |

- **CPU**: 4-8코어, x86-64 프로세서는 AVX2 명령어 셋 호환 필수
- **디스크**: 고성능 NVMe SSD 권장, 다중 디스크 시 소프트웨어 RAID 0 권장

### 12.2 사전 요구사항

| 도구 | 용도 | 설치 |
|------|------|------|
| Rust 툴체인 (1.90.0) | 빌드 | `rustup` 사용 |
| libclang | RocksDB 빌드 | OS 패키지 매니저 |
| Git | 소스 코드 관리 | OS 패키지 매니저 |
| solc (v0.8.31) | L2 개발 시 컨트랙트 컴파일 | solidity 공식 문서 참조 |
| Lighthouse | 합의 클라이언트 (L1 노드 구동 시) | `brew install lighthouse` 또는 GitHub 릴리스 |

### 12.3 설치 방법

#### 방법 1: Homebrew (macOS)

```sh
brew install lambdaclass/tap/ethrex
```

#### 방법 2: 바이너리 다운로드 (Linux x86)

```sh
curl -L https://github.com/lambdaclass/ethrex/releases/latest/download/ethrex-linux-x86_64 -o ethrex
chmod +x ethrex
```

#### 방법 3: cargo install (소스에서 설치)

```sh
cargo install --locked ethrex --git https://github.com/lambdaclass/ethrex.git
```

선택적 기능 플래그:
- `--features sp1,risc0` : SP1/RISC Zero 프루버 활성화
- `--features gpu` : CUDA GPU 지원

#### 방법 4: 소스에서 직접 빌드

```sh
git clone https://github.com/lambdaclass/ethrex.git
cd ethrex
cargo build --bin ethrex --release
# 바이너리 위치: target/release/ethrex
```

설치 확인:

```sh
ethrex --version
```

### 12.4 L1 노드 실행 (테스트넷/메인넷)

ethrex는 **실행 클라이언트(Execution Client)**이므로 반드시 **합의 클라이언트(Consensus Client)**와 함께 실행해야 한다.

#### Step 1: JWT 비밀키 생성

두 클라이언트 간 인증 통신에 사용되는 공유 비밀키를 생성한다.

```sh
mkdir -p ethereum/secrets/
cd ethereum/
openssl rand -hex 32 | tr -d "\n" | tee ./secrets/jwt.hex
```

#### Step 2: ethrex 실행 (터미널 1)

```sh
# Hoodi 테스트넷 (가장 가볍고, 입문에 추천)
ethrex --authrpc.jwtsecret ./secrets/jwt.hex --network hoodi

# Sepolia 테스트넷
ethrex --authrpc.jwtsecret ./secrets/jwt.hex --network sepolia --syncmode snap

# 이더리움 메인넷
ethrex --authrpc.jwtsecret ./secrets/jwt.hex --syncmode snap
```

#### Step 3: Lighthouse (합의 클라이언트) 실행 (터미널 2)

```sh
lighthouse bn \
  --network hoodi \
  --execution-endpoint http://localhost:8551 \
  --execution-jwt ./secrets/jwt.hex \
  --checkpoint-sync-url https://hoodi.checkpoint.sigp.io \
  --http
```

> 네트워크를 변경할 경우 `--network` 값을 맞춰야 한다 (예: sepolia, mainnet).

#### Step 4: 동기화 상태 확인

```sh
curl http://localhost:8545 \
  -H 'content-type: application/json' \
  -d '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}'
```

응답 예시:
```json
{"id":1,"jsonrpc":"2.0","result":{"startingBlock":"0x0","currentBlock":"0x0","highestBlock":"0x0"}}
```

### 12.5 Docker로 실행 (가장 간단)

합의 클라이언트 + ethrex를 Docker Compose로 한 번에 실행할 수 있다.

```sh
# docker-compose 파일 다운로드
curl -L -o docker-compose.yaml \
  https://raw.githubusercontent.com/lambdaclass/ethrex/refs/heads/main/docker-compose.yaml

# 실행 (기본: Holesky)
docker compose up

# 특정 네트워크 지정
ETHREX_NETWORK=hoodi docker compose up
```

### 12.6 개발 모드 (합의 클라이언트 불필요)

빠른 테스트/개발 목적으로 합의 클라이언트 없이 단독 실행한다. 자동으로 블록을 생성한다.

```sh
# Makefile 사용
make dev

# 또는 직접 실행
cargo run --release -- --dev --datadir memory
```

- `--dev` : 개발 모드 활성화 (자동 블록 생성, 합의 클라이언트 불필요)
- `--datadir memory` : 인메모리 데이터베이스 사용 (종료 시 데이터 소멸)

### 12.7 L2 모드 실행

```sh
# macOS
brew install lambdaclass/tap/ethrex
ethrex l2 --dev

# Linux
./ethrex l2 --dev

# 소스에서 빌드 후 실행 (L2 컨트랙트 컴파일 필요)
export COMPILE_CONTRACTS=true
cargo build --bin ethrex --release --features l2
./target/release/ethrex l2 --dev
```

### 12.8 로컬 네트워크 (Kurtosis)

여러 클라이언트가 포함된 로컬 테스트 네트워크를 구동한다. Docker와 Kurtosis CLI가 사전 설치되어 있어야 한다.

```sh
# 로컬 네트워크 시작 (Docker 이미지 빌드 포함)
make localnet

# 커스텀 네트워크 설정 파일 지정
make localnet KURTOSIS_CONFIG_FILE=./fixtures/networks/ethrex_only.yaml

# 로컬 네트워크 중지
make stop-localnet
```

### 12.9 구동 방법 요약 표

| 목적 | 명령어 | 합의 클라이언트 필요 |
|------|--------|-------------------|
| **빠른 개발/테스트** | `make dev` | 불필요 |
| **L1 노드 (Hoodi 테스트넷)** | `ethrex --network hoodi --authrpc.jwtsecret jwt.hex` | 필요 (Lighthouse 등) |
| **L1 노드 (Sepolia 테스트넷)** | `ethrex --network sepolia --syncmode snap --authrpc.jwtsecret jwt.hex` | 필요 |
| **L1 노드 (메인넷)** | `ethrex --syncmode snap --authrpc.jwtsecret jwt.hex` | 필요 |
| **Docker (올인원)** | `docker compose up` | 포함됨 |
| **L2 개발** | `ethrex l2 --dev` | 불필요 |
| **로컬 네트워크** | `make localnet` | 포함됨 |

### 12.10 주요 포트 정리

| 포트 | 프로토콜 | 설명 |
|------|---------|------|
| 8545 | HTTP | 공개 JSON-RPC API |
| 8546 | WebSocket | 실시간 구독 |
| 8551 | HTTP (JWT) | Engine API (합의 클라이언트 전용) |
| 30303 | TCP/UDP | P2P 네트워킹 및 디스커버리 |

## 13. 보안 정책

- 보안 취약점 보고: `.github/SECURITY.md`
- CODEOWNERS 기반 코드 리뷰 필수
- 린트 + 테스트 + AI 리뷰 자동화
- 라이선스 검사 자동화
