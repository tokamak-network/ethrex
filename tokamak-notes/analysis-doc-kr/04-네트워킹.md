# Ethrex 프로젝트 분석 - 네트워킹 레이어

## 1. P2P 네트워킹 개요

Ethrex는 완전한 이더리움 DevP2P 프로토콜 스택을 구현한다.

```
네트워크 레이어
├── discv4/discv5 (노드 디스커버리)
├── RLPx (암호화 전송)
├── Peer Handler (메시지 라우팅)
└── Peer Connection (TCP 소켓 관리)
         │
├── Sync Manager (블록 동기화 조정)
├── TX Broadcaster (트랜잭션 풀 브로드캐스트)
└── Snap Sync (빠른 상태 동기화)
```

**위치**: `crates/networking/p2p/`

## 2. 디스커버리 프로토콜

### 2.1 discv4 (안정 버전)

UDP 기반 노드 디스커버리 프로토콜 (Kademlia DHT):

**메시지 타입**:
| 메시지 | 설명 |
|--------|------|
| PING | 피어 도달성 확인 |
| PONG | PING 응답 |
| FIND_NEIGHBORS | 네트워크 토폴로지 탐색 |
| NEIGHBORS | 피어 엔드포인트 정보 응답 |

**동작**:
1. 부트노드로 초기 네트워크 진입
2. PING/PONG으로 피어 생존 확인
3. FIND_NEIGHBORS로 새로운 피어 탐색
4. 주기적 피어 조회 (설정 가능한 간격)

### 2.2 discv5 (실험적)

향상된 디스커버리 프로토콜:

| 특징 | 설명 |
|------|------|
| ENR 지원 | Ethereum Node Records로 풍부한 노드 정보 |
| 토픽 기반 탐색 | 특정 기능/서비스별 피어 탐색 |
| 세션 기반 통신 | 암호화된 세션 |
| 토픽 테이블 관리 | 토픽별 피어 그룹화 |

> **참고**: `experimental-discv5` 피처 게이트로 활성화

## 3. RLPx 암호화 전송

### 3.1 프로토콜 구성요소

| 구성요소 | 설명 |
|----------|------|
| 연결 핸드셰이크 | ECIES 암호화 협상 + 피어 인증 |
| 메시지 프레이밍 | RLP 인코딩 + 프로토콜 버저닝 |
| 연결 서버 | TCP 리스너 (기본 포트 30303) |

### 3.2 지원 캐이퍼빌리티

```
eth 프로토콜 메시지:     오프셋 0x10 부터 시작
snap 프로토콜 (eth/68):  오프셋 0x21 부터 시작
snap 프로토콜 (eth/69):  오프셋 0x22 부터 시작
L2 based (eth/68):       오프셋 0x30 부터 시작
L2 based (eth/69):       오프셋 0x31 부터 시작
```

### 3.3 메시지 타입

#### P2P 기본 메시지
| 메시지 | 설명 |
|--------|------|
| Hello | 연결 초기 핸드셰이크 |
| Disconnect | 연결 해제 |
| Ping | 연결 유지 확인 |
| Pong | Ping 응답 |

#### eth 프로토콜 메시지
| 메시지 | 방향 | 설명 |
|--------|------|------|
| Status | 양방향 | 상태 교환 (네트워크 ID, 제네시스 등) |
| GetBlockHeaders | 요청 | 블록 헤더 요청 |
| BlockHeaders | 응답 | 블록 헤더 응답 |
| GetBlockBodies | 요청 | 블록 바디 요청 |
| BlockBodies | 응답 | 블록 바디 응답 |
| Transactions | 브로드캐스트 | 트랜잭션 전파 |
| NewPooledTransactionHashes | 알림 | 새 트랜잭션 해시 알림 |
| GetPooledTransactions | 요청 | 풀의 트랜잭션 요청 |
| PooledTransactions | 응답 | 풀의 트랜잭션 응답 |
| GetReceipts | 요청 | 영수증 요청 |
| Receipts | 응답 | 영수증 응답 |
| BlockRangeUpdate | 알림 | 블록 범위 업데이트 |

#### snap 프로토콜 메시지
| 메시지 | 방향 | 설명 |
|--------|------|------|
| GetAccountRange | 요청 | 해시 범위 내 계정 요청 |
| AccountRange | 응답 | 계정 목록 응답 |
| GetStorageRanges | 요청 | 스토리지 슬롯 요청 |
| StorageRanges | 응답 | 스토리지 슬롯 응답 |
| GetByteCodes | 요청 | 컨트랙트 바이트코드 요청 |
| ByteCodes | 응답 | 바이트코드 응답 |
| GetTrieNodes | 요청 | 트라이 노드 요청 |
| TrieNodes | 응답 | 트라이 노드 응답 |

#### L2 Based 프로토콜 메시지
| 메시지 | 설명 |
|--------|------|
| NewBlock | L2 블록 알림 |
| BatchSealed | L2 배치 완료 신호 |

## 4. 피어 관리

### 4.1 PeerTable (피어 테이블)

```
피어 테이블
├── 연결된 피어 메타데이터 관리
├── 피어 캐이퍼빌리티 및 상태 추적
├── 디스커버리 상태 전이 관리
└── 설정 가능한 피어 제한
```

### 4.2 PeerHandler (피어 핸들러)

- 중앙 메시지 라우터
- 피어별 아웃바운드 요청 관리 (타임아웃 처리)
- 대기 중인 응답 및 요청 ID 추적
- 피어 연결 해제 시 정리

### 4.3 네트워크 초기화 과정

```
1. UDP 소켓 바인딩 (디스커버리용)
    │
2. DiscoveryServer 시작 (부트노드와 연결)
    │
3. P2P 요청 서버 TCP 리스너 시작
    │
4. 들어오는 피어 연결 수락
    │
5. 피어 상태 메시지 검증
    │  - 네트워크 ID 일치 확인
    │  - eth 프로토콜 버전 확인
    │  - 제네시스 해시 검증
    │  - Fork ID 호환성 검증
    │
6. 주기적 피어 통계 브로드캐스트
```

## 5. 스냅 싱크 메커니즘

### 5.1 싱크 매니저 (SyncManager)

```rust
SyncManager {
    snap_sync_enabled: bool,     // 스냅 싱크 활성화 여부
    last_fcu_head: H256,         // 마지막 ForkchoiceUpdate 헤드
    // ...
}
```

**생명주기**:
```
new() → 자동 전환 검사 (snap→full)
  │
sync_to_head(fcu_head) → 헤드 설정 + 싱크 시작
  │
start_sync() → Syncer::start_sync(sync_cycle)
  │
sync_cycle_snap() 또는 sync_cycle_full()
  │
캐노니컬 체인 업데이트 → 다음 사이클 (추가 블록 있으면)
```

### 5.2 스냅 싱크 8단계

#### Phase 1: 블록 헤더 다운로드
- 피벗 블록에서 0~32K 블록 범위
- 캐노니컬 상태 루트 타깃 확립

#### Phase 2-3: 계정 다운로드 및 삽입
```
GetAccountRange 요청 (니블 범위 [0x00, 0xFF])
    │
피벗 블록에 대해 계정 상태 루트 검증
    │
계정 트라이 데이터베이스에 병렬 삽입
```

#### Phase 4-5: 스토리지 다운로드 및 삽입
```
각 계정의 GetStorageRanges 요청
    │
계정에 대해 스토리지 루트 검증
    │
스토리지 슬롯 병렬 삽입
    │
대용량 스토리지 계정은 청크 요청으로 처리
```

#### Phase 6-7: 상태 및 스토리지 힐링
```
누락된 중간 트라이 노드에 대한 GetTrieNodes 요청
    │
해시 검증으로 머클 트리 무결성 확보
    │
완료될 때까지 반복적 힐링
```

#### Phase 8: 바이트코드 다운로드
```
컨트랙트 코드 GetByteCodes 요청
    │
keccak 해시로 코드 검증
    │
최종 동기화 단계
```

### 5.3 주요 상수

| 상수 | 값 | 설명 |
|------|-----|------|
| ACCOUNT_RANGE_BYTES | 16,000 | 계정 범위 응답 최대 크기 |
| STORAGE_RANGE_BYTES | 16,000 | 스토리지 범위 응답 최대 크기 |
| BYTECODE_LIMIT_PER_REQUEST | 60 | 요청당 최대 바이트코드 수 |
| TRIE_NODES_BATCH_SIZE | 500 | 요청당 최대 트라이 노드 수 |

### 5.4 임시 파일 (싱크 중)

| 경로 | 내용 |
|------|------|
| `leaves/account_state_snapshots/` | 계정 상태 스냅샷 |
| `leaves/account_storages_snapshots/` | 스토리지 스냅샷 |
| `leaves/code_hashes_snapshots/` | 코드 해시 |

> 싱크 완료 또는 노드 재시작 시 정리됨

## 6. JSON-RPC API

### 6.1 서버 아키텍처

Ethrex는 3개의 HTTP/WebSocket 엔드포인트를 제공한다:

| 엔드포인트 | 포트 | 인증 | 설명 |
|-----------|------|------|------|
| Public HTTP RPC | 8545 | 없음 | 표준 이더리움 JSON-RPC |
| WebSocket | 8546 | 없음 | 실시간 구독 지원 |
| Auth RPC (Engine API) | 8551 | JWT | 합의 클라이언트 전용 |

### 6.2 지원 네임스페이스

#### eth 네임스페이스 (표준 이더리움)

| 메서드 | 설명 |
|--------|------|
| `eth_blockNumber` | 최신 블록 번호 |
| `eth_getBalance` | 계정 잔액 조회 |
| `eth_getTransactionCount` | 계정 논스 조회 |
| `eth_getBlockByNumber` | 번호로 블록 조회 |
| `eth_getBlockByHash` | 해시로 블록 조회 |
| `eth_getTransactionByHash` | 해시로 트랜잭션 조회 |
| `eth_getTransactionReceipt` | 트랜잭션 영수증 조회 |
| `eth_sendRawTransaction` | 서명된 트랜잭션 전송 |
| `eth_call` | 읽기 전용 호출 |
| `eth_estimateGas` | 가스 추정 |
| `eth_gasPrice` | 가스 가격 |
| `eth_getCode` | 컨트랙트 코드 조회 |
| `eth_getStorageAt` | 스토리지 슬롯 조회 |
| `eth_getProof` | 머클 증명 |
| `eth_getLogs` | 이벤트 로그 조회 |
| `eth_feeHistory` | 수수료 이력 |
| `eth_maxPriorityFeePerGas` | 최대 우선 수수료 |

#### engine 네임스페이스 (합의 클라이언트)

| 메서드 | 설명 |
|--------|------|
| `engine_forkchoiceUpdatedV1/V2/V3/V4` | 포크 초이스 업데이트 |
| `engine_newPayloadV1/V2/V3/V4/V5` | 새 실행 페이로드 수락 |
| `engine_getPayloadV1/V2/V3/V4/V5/V6` | 빌드된 페이로드 조회 |
| `engine_getBlobsV1/V2/V3` | 블롭 데이터 조회 |
| `engine_exchangeTransitionConfigurationV1` | 전환 설정 교환 |
| `engine_getClientVersionV1` | 클라이언트 버전 |

#### debug 네임스페이스

| 메서드 | 설명 |
|--------|------|
| `debug_getRawHeader` | 원시 헤더 RLP |
| `debug_getRawBlock` | 원시 블록 RLP |
| `debug_getRawTransaction` | 원시 트랜잭션 RLP |
| `debug_getRawReceipts` | 원시 영수증 RLP |

#### 기타 네임스페이스

| 네임스페이스 | 메서드 예시 |
|-------------|------------|
| `net` | `net_version`, `net_peerCount`, `net_listening` |
| `admin` | `admin_nodeInfo`, `admin_peers` |
| `web3` | `web3_clientVersion`, `web3_sha3` |
| `txpool` | `txpool_content` |

### 6.3 Engine API 상세

#### 페이로드 구조 (ExecutionPayload)

```rust
ExecutionPayload {
    parent_hash: H256,           // 부모 블록 해시
    fee_recipient: Address,      // 수수료 수신자
    state_root: H256,            // 상태 루트
    receipts_root: H256,         // 영수증 루트
    logs_bloom: Bloom,           // 로그 블룸
    prev_randao: H256,           // RANDAO 값
    block_number: u64,           // 블록 번호
    gas_limit: u64,              // 가스 리밋
    gas_used: u64,               // 사용된 가스
    timestamp: u64,              // 타임스탬프
    extra_data: Bytes,           // 추가 데이터
    base_fee_per_gas: U256,      // 기본 수수료
    block_hash: H256,            // 블록 해시
    transactions: Vec<Transaction>, // 트랜잭션 목록

    // EIP-4844
    excess_blob_gas: Option<u64>,
    blob_gas_used: Option<u64>,

    // EIP-7685
    requests: Option<EncodedRequests>,
}
```

#### 포크 초이스 업데이트 흐름

```
합의 클라이언트 → engine_forkchoiceUpdatedV3
    │
    v
1. 포크 초이스 상태 검증
    ├── 헤드 해시가 존재하는 블록인지
    ├── finalized ≤ safe ≤ head 순서
    └── 블록들이 연결되어 있는지
    │
2. 캐노니컬 체인 업데이트
    │
3. PayloadAttributes가 있으면 페이로드 빌딩 시작
    │
4. VALID 또는 SYNCING 상태 반환
```

#### JWT 인증

```
HTTP 요청 헤더:
  Authorization: Bearer <JWT_TOKEN>

JWT 페이로드:
  {
    "iat": <unix_timestamp>  // 발급 시간 (±60초 허용)
  }

JWT 서명:
  HMAC-SHA256 (공유 비밀키)
```

## 7. 트랜잭션 브로드캐스터

### 7.1 역할

- 새 트랜잭션을 연결된 피어들에게 전파
- 중복 전파 방지 (이미 알고 있는 피어 제외)
- 배치 전송으로 효율성 향상

### 7.2 전파 전략

```
새 트랜잭션 수신
    │
    v
멤풀에 추가
    │
    v
연결된 피어에게 NewPooledTransactionHashes 전송
    │
    v
피어가 관심 표시 시 → GetPooledTransactions → PooledTransactions
```

## 8. 메트릭

### 8.1 P2P 싱크 메트릭

| 메트릭 | 설명 |
|--------|------|
| downloaded_headers | 다운로드된 헤더 수 |
| downloaded_accounts | 다운로드된 계정 수 |
| downloaded_storage_slots | 다운로드된 스토리지 슬롯 수 |
| downloaded_bytecodes | 다운로드된 바이트코드 수 |
| healed_state_paths | 힐링된 상태 경로 수 |
| healed_storage_paths | 힐링된 스토리지 경로 수 |
| current_sync_phase | 현재 싱크 단계 |
| peer_count | 연결된 피어 수 |

### 8.2 RPC 메트릭

| 메트릭 | 설명 |
|--------|------|
| request_rate_by_method | 메서드별 요청 빈도 |
| success_error_rate | 성공/에러 비율 |
| latency_by_method | 메서드별 지연 시간 |
| total_time_per_method | 메서드별 총 소요 시간 |
