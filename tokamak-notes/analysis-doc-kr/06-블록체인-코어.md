# Ethrex 프로젝트 분석 - 블록체인 코어

## 1. 블록체인 모듈 개요

블록체인 코어 모듈은 블록 검증, 실행, 상태 관리, 포크 초이스, 멤풀 등 이더리움 실행 클라이언트의 핵심 로직을 담당한다.

**위치**: `crates/blockchain/`

```
crates/blockchain/
├── blockchain.rs    # 핵심 블록체인 로직
├── constants.rs     # 상수 정의
├── error.rs         # 에러 타입
├── fork_choice.rs   # 포크 초이스 규칙
├── mempool.rs       # 트랜잭션 풀
├── payload.rs       # 페이로드 빌딩
├── tracing.rs       # 트레이싱
├── vm.rs            # VM 데이터베이스 브릿지
├── dev/             # 개발 모드
└── metrics/         # Prometheus 메트릭
```

## 2. Blockchain 구조체

### 2.1 핵심 필드

```rust
pub struct Blockchain {
    store: Store,                        // 블록 및 상태 스토리지
    mempool: Arc<Mempool>,               // 트랜잭션 풀
    config: ChainConfig,                 // 네트워크 파라미터
    is_synced: Arc<AtomicBool>,          // 동기화 상태
    blocks_synced: Arc<AtomicUsize>,     // 동기화된 블록 수 (메트릭)
    // ...
}
```

### 2.2 주요 API

| 메서드 | 설명 |
|--------|------|
| `add_block()` | 블록을 체인에 추가 |
| `add_block_pipeline()` | 블록을 즉시 실행 |
| `add_transaction_to_mempool()` | 멤풀에 트랜잭션 추가 |
| `build_payload()` | 블록 템플릿 생성 |
| `get_payload()` | 빌드된 페이로드 조회 |

## 3. 블록 검증 파이프라인

### 3.1 헤더 검증

```
수신된 블록 헤더
    │
    ├── 부모 블록 존재 확인
    │   └── 부모가 DB에 있어야 함
    │
    ├── 타임스탬프 검증
    │   └── 현재 타임스탬프 > 부모 타임스탬프
    │
    ├── 가스 리밋 검증
    │   ├── 부모 가스 리밋의 1/1024 범위 내
    │   └── 최소 5,000 이상
    │
    ├── 블록 번호 검증
    │   └── parent_number + 1 == current_number
    │
    ├── Extra Data 크기 검증
    │   └── 32바이트 이하
    │
    ├── Difficulty/PrevRandao 검증
    │   └── 포스트-머지: difficulty == 0
    │
    └── 포크별 필드 검증
        ├── Shanghai: withdrawals_root 필수
        ├── Cancun: blob_gas, beacon_root 필수
        ├── Prague: requests_hash 필수
        └── Amsterdam: access_list_hash, slot_number 필수
```

### 3.2 바디 검증

```
블록 바디 검증
    │
    ├── 트랜잭션 수 < 2^16
    │
    ├── 총 데이터 크기 < 2^24 바이트
    │
    ├── Initcode 크기 검사 (EIP-3860)
    │   └── 최대 49,152 바이트
    │
    ├── 트랜잭션 RLP 유효성
    │   └── 각 트랜잭션이 올바르게 인코딩
    │
    └── 출금 수 < 2^16 (Shanghai+)
```

### 3.3 트랜잭션 실행

```
각 트랜잭션에 대해:
    │
    ├── 1. 서명 검증
    │   └── ECDSA 서명 복구 → 발신자 주소
    │
    ├── 2. 논스 검증
    │   └── tx.nonce == account.nonce
    │
    ├── 3. 잔액 검증
    │   └── balance >= value + gas_limit * gas_price
    │
    ├── 4. EVM 실행
    │   ├── 콜 프레임 생성
    │   ├── 옵코드 순차 실행
    │   ├── 상태 변경 수집
    │   └── 가스 소비 추적
    │
    ├── 5. 상태 변경 적용
    │   ├── 잔액 업데이트
    │   ├── 스토리지 변경
    │   └── 코드 배포 (CREATE/CREATE2)
    │
    ├── 6. 가스 및 수수료 수집
    │   ├── gas_used = gas_limit - remaining_gas
    │   ├── 환불 계산 (최대 gas_used/5)
    │   └── 수수료 = gas_price * gas_used
    │
    ├── 7. 논스 업데이트
    │   └── account.nonce += 1
    │
    └── 8. 영수증 기록
        ├── 성공/실패 상태
        ├── 누적 가스 사용량
        ├── 로그
        └── 블룸 필터
```

### 3.4 상태 루트 검증

```
모든 트랜잭션 실행 완료 후:
    │
    ├── 출금 처리 (Shanghai+)
    │   └── 각 출금에 대해 잔액 증가
    │
    ├── 요청 추출 (Prague+)
    │   ├── 입금 요청
    │   ├── 출금 요청
    │   └── 통합 요청
    │
    ├── 상태 트라이 루트 계산
    │   └── 수정된 계정의 트라이 업데이트
    │
    └── 검증
        ├── 계산된 state_root == 헤더 state_root
        ├── 계산된 receipts_root == 헤더 receipts_root
        ├── 계산된 logs_bloom == 헤더 logs_bloom
        └── 계산된 requests_hash == 헤더 requests_hash
```

## 4. 포크 초이스 (Fork Choice)

### 4.1 LMD-GHOST

Ethrex는 포스트-머지 이더리움의 포크 초이스 규칙인 LMD-GHOST (Latest Message Driven Greediest Heaviest Observed Sub-Tree)를 구현한다. 실행 클라이언트로서 합의 클라이언트로부터 포크 초이스 업데이트를 수신한다.

### 4.2 포크 초이스 상태

```rust
ForkChoiceState {
    head_block_hash: H256,       // 현재 헤드 (가장 최신)
    safe_block_hash: H256,       // 안전 블록 (2/3 합의)
    finalized_block_hash: H256,  // 최종 확정 (되돌릴 수 없음)
}
```

### 4.3 검증 로직

```rust
apply_fork_choice(store, head, safe, finalized):
    │
    ├── head_hash가 존재하는 블록인지 확인
    │
    ├── 순서 검증: finalized ≤ safe ≤ head
    │
    ├── 모든 블록이 DB에 존재하는지 확인
    │
    ├── head가 캐노니컬 체인과 연결되는지 확인
    │
    └── finalized, safe가 head의 조상이거나
        이미 캐노니컬인지 확인
```

### 4.4 업데이트 과정

```
1. head와 그 조상 블록을 캐노니컬으로 설정
    │
2. 블록 번호별 캐노니컬 해시 매핑 업데이트
    │
3. 리오그(reorg) 마커 리셋
    │
4. VALID 또는 SYNCING 상태 반환
```

### 4.5 리오그 (Reorganization) 처리

```
기존 캐노니컬: A → B → C → D
새 포크:       A → B → C' → D' → E'

리오그 과정:
1. C, D를 캐노니컬에서 제거
2. C', D', E'를 캐노니컬로 설정
3. 멤풀에 C, D의 트랜잭션 반환
4. C', D', E'의 트랜잭션을 멤풀에서 제거
```

## 5. 멤풀 (Mempool)

### 5.1 데이터 구조

```rust
Mempool {
    transaction_pool: HashMap<H256, MempoolTransaction>,
    blobs_bundle_pool: HashMap<H256, BlobsBundle>,
    txs_by_sender_nonce: BTreeMap<(Address, u64), H256>,
    txs_order: VecDeque<H256>,
    max_mempool_size: usize,
}
```

### 5.2 트랜잭션 삽입

```
트랜잭션 수신
    │
    ├── 서명 검증
    │
    ├── 기본 유효성 검사
    │   ├── 가스 리밋 > 0
    │   ├── 값 오버플로우 확인
    │   └── 논스 유효성
    │
    ├── 중복 검사
    │   └── 동일 발신자+논스 트랜잭션 존재 시 가스 가격 비교
    │
    ├── 풀 크기 확인
    │   └── 최대 크기 초과 시 가장 오래된 트랜잭션 제거
    │
    └── 삽입
        ├── transaction_pool에 추가
        ├── txs_by_sender_nonce에 인덱스
        └── txs_order에 순서 기록
```

### 5.3 트랜잭션 선택 (블록 빌딩용)

```
get_transactions():
    │
    ├── 가스 가격 순으로 정렬
    │
    ├── 블록 가스 리밋까지 트랜잭션 선택
    │
    ├── 발신자별 논스 순서 보장
    │
    └── 유효하지 않은 트랜잭션 건너뛰기
```

### 5.4 블롭 번들 관리

EIP-4844 블롭 트랜잭션의 블롭 데이터는 별도 풀에서 관리:

```rust
blobs_bundle_pool: HashMap<H256, BlobsBundle>
// tx_hash → BlobsBundle 매핑
```

## 6. 페이로드 빌딩 (Payload Building)

### 6.1 빌드 인자

```rust
BuildPayloadArgs {
    timestamp: u64,                     // 목표 타임스탬프
    prev_randao: H256,                  // RANDAO 값
    suggested_fee_recipient: Address,   // 수수료 수신자
    withdrawals: Vec<Withdrawal>,       // 출금 목록
    parent_block_hash: H256,            // 부모 블록
    parent_blob_gas_used: Option<u64>,  // 블롭 가스
}
```

### 6.2 빌딩 과정

```
1. 부모 블록 및 상태 가져오기
    │
2. 기본 수수료 계산 (EIP-1559)
    │   base_fee = 부모_base_fee ×
    │              (1 + (gas_used - target) / target / 8)
    │
3. 초과 블롭 가스 계산 (EIP-4844)
    │   excess = max(0, parent_excess + parent_used - target)
    │
4. 멤풀에서 트랜잭션 선택
    │   - 가스 가격 순 정렬
    │   - 블록 가스 리밋 준수
    │
5. 시스템 연산 실행
    │   - 비콘 루트 저장 (EIP-4788)
    │   - 블록 해시 이력 (EIP-2935)
    │
6. 트랜잭션 순차 실행
    │   - 유효하지 않은 트랜잭션 건너뛰기
    │   - 가스 소진 시 중단
    │
7. 출금 처리
    │
8. 요청 추출
    │
9. 상태 루트 계산
    │
10. ExecutionPayload 구성
```

### 6.3 비동기 페이로드 빌딩

```rust
PayloadBuildTask {
    cancellation_token: CancellationToken,  // 취소 토큰
    // ...
}
```

- `CancellationToken`으로 취소 가능
- 클라이언트가 페이로드 완성을 기다릴 수 있음
- 빌드된 페이로드 캐싱

## 7. VM 데이터베이스 브릿지

### 7.1 StoreVmDatabase

`crates/blockchain/vm.rs`에서 Store와 LEVM 간의 브릿지를 제공:

```rust
impl VmDatabase for StoreVmDatabase {
    fn get_account_state(&self, address: Address) -> Result<Option<AccountState>>;
    fn get_storage_slot(&self, address: Address, key: H256) -> Result<Option<U256>>;
    fn get_block_hash(&self, block_number: u64) -> Result<H256>;
    fn get_chain_config(&self) -> Result<ChainConfig>;
    fn get_account_code(&self, code_hash: H256) -> Result<Code>;
    fn get_code_metadata(&self, code_hash: H256) -> Result<CodeMetadata>;
}
```

### 7.2 블록 해시 조회 최적화

```
블록 해시 조회 경로:
    │
    ├── 빠른 경로: 캐노니컬 블록
    │   └── 블록 번호 → 캐노니컬 해시 직접 조회
    │
    └── 느린 경로: 비캐노니컬 블록
        └── 조상 블록을 따라 올라가며 찾기
        └── 중간 결과 캐싱 (배치 실행 최적화)
```

## 8. 개발 모드 (Dev Mode)

### 8.1 BlockProducer (개발 모드)

`crates/blockchain/dev/`에서 개발 모드 블록 프로듀서 제공:

```
개발 모드 특징:
├── 인메모리 데이터베이스 사용 가능
├── 자동 블록 생성 (트랜잭션 도착 시)
├── 합의 클라이언트 불필요
├── 즉시 블록 확정
└── 빠른 테스트 및 개발 지원
```

## 9. 메트릭

### 9.1 블록 메트릭

| 메트릭 | 설명 |
|--------|------|
| block_height | 현재 블록 높이 |
| block_time | 블록 간 시간 |
| gas_used | 블록당 가스 사용량 |
| block_execution_time | 블록 실행 시간 |

### 9.2 트랜잭션 메트릭

| 메트릭 | 설명 |
|--------|------|
| tx_count | 블록당 트랜잭션 수 |
| tx_execution_time | 트랜잭션 실행 시간 |
| mempool_size | 멤풀 크기 |

### 9.3 노드 메트릭

| 메트릭 | 설명 |
|--------|------|
| peer_count | 연결된 피어 수 |
| sync_progress | 동기화 진행률 |
| uptime | 노드 가동 시간 |

### 9.4 프로세스 메트릭

| 메트릭 | 설명 |
|--------|------|
| cpu_usage | CPU 사용률 |
| memory_usage | 메모리 사용량 |
| open_fds | 열린 파일 디스크립터 수 |
| threads | 스레드 수 |

## 10. 에러 처리

### 10.1 ChainError 타입

```rust
enum ChainError {
    // 블록 검증 에러
    InvalidBlock(String),
    ParentNotFound,
    InvalidStateRoot,
    InvalidReceiptsRoot,

    // 실행 에러
    EvmError(EvmError),
    StorageError(StoreError),

    // 포크 초이스 에러
    InvalidForkChoice(String),

    // 기타
    Internal(String),
}
```

### 10.2 에러 전파

```
트랜잭션 실행 에러
    → EvmError
        → ChainError::EvmError
            → JSON-RPC 에러 응답 또는 engine_newPayload INVALID 응답
```

## 11. 상수 (Constants)

### 11.1 블록 관련

| 상수 | 값 | 설명 |
|------|-----|------|
| MAX_EXTRA_DATA_SIZE | 32 | Extra Data 최대 바이트 |
| MIN_GAS_LIMIT | 5,000 | 최소 가스 리밋 |
| GAS_LIMIT_BOUND_DIVISOR | 1,024 | 가스 리밋 변경 범위 |
| ELASTICITY_MULTIPLIER | 2 | EIP-1559 탄력성 승수 |
| BASE_FEE_MAX_CHANGE_DENOMINATOR | 8 | 기본 수수료 최대 변경율 |

### 11.2 EIP-4844 (블롭)

| 상수 | 값 | 설명 |
|------|-----|------|
| MAX_BLOBS_PER_BLOCK (Cancun) | 6 | 블록당 최대 블롭 수 |
| MAX_BLOBS_PER_BLOCK (Prague) | 8 | 블록당 최대 블롭 수 |
| BLOB_TX_MIN_BLOB_GASPRICE | 1 | 최소 블롭 가스 가격 |
| BLOB_BASE_FEE_UPDATE_FRACTION | 3,338,477 | 기본 수수료 갱신 비율 |

### 11.3 시스템 컨트랙트 주소

| 상수 | 주소 | 설명 |
|------|------|------|
| BEACON_ROOTS | 0x000...0B | 비콘 루트 저장소 |
| HISTORY_STORAGE | 0x000...25 | 블록 해시 이력 |
| DEPOSIT_CONTRACT | 0x000...01 | 입금 컨트랙트 |
| WITHDRAWAL_REQUEST | 0x000...0A | 출금 요청 |
| CONSOLIDATION_REQUEST | 0x000...0B | 통합 요청 |
