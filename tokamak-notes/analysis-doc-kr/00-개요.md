# Ethrex 프로젝트 분석 - 개요

## 1. 프로젝트 소개

**Ethrex**는 [LambdaClass](https://lambdaclass.com/)에서 개발한 **Rust 기반 이더리움 프로토콜 구현체**이다. 최소주의(minimalist), 안정성(stable), 모듈성(modular), 고성능(fast), ZK-네이티브(ZK-native) 설계를 핵심 철학으로 삼고 있다.

- **버전**: 9.0.0
- **Rust 에디션**: 2024
- **라이선스**: MIT / Apache-2.0 (이중 라이선스)
- **Rust 파일 수**: 약 489개
- **Rust 툴체인**: 1.90.0

## 2. 프로젝트의 역할

Ethrex는 두 가지 역할을 동시에 수행한다:

### 2.1 L1 실행 클라이언트 (Execution Client)
- 이더리움 메인넷/테스트넷의 실행 레이어 클라이언트
- Lighthouse, Prysm 등 합의 클라이언트와 Engine API로 통신
- 블록 실행, 상태 관리, P2P 네트워킹, JSON-RPC API 제공

### 2.2 L2 ZK-롤업 플랫폼
- 다중 프루버(Multi-Prover) ZK-Rollup 시퀀서
- SP1, RISC Zero, Zisk, OpenVM, TEE 등 다양한 증명 백엔드 지원
- L1-L2 브릿지, 입출금, 배치 커밋 및 검증

## 3. 설계 철학

| 원칙 | 설명 |
|------|------|
| **최소주의** | 추상화를 최소화하고, 필요가 증명될 때만 추상화 도입 |
| **수직 통합** | 자체 EVM(LEVM), RLP, Merkle Patricia Trie, 암호화 래퍼 구현 |
| **ZK-네이티브** | 영지식 증명을 사후 추가가 아닌 핵심 설계 원칙으로 채택 |
| **가독성 우선** | 코드 반복을 허용하되 가독성과 유지보수성을 우선시 |
| **최소 동시성** | 꼭 필요한 경우에만 동시성 도입 |
| **최소 의존성** | 외부 라이브러리 의존을 최소화하여 공급망 리스크 감소 |

## 4. 경쟁 제품 대비 특징

Geth(Go), Nethermind(C#), Erigon(Go), Reth(Rust) 등 기존 이더리움 클라이언트 대비:

- **코드베이스가 현저히 작음** - 유지보수 용이
- **ZK 증명을 처음부터 고려한 설계** - 롤업 최적화
- **Rust의 메모리 안전성과 성능** 활용
- **L1 + L2 통합 플랫폼** - 하나의 코드베이스로 두 역할 수행

## 5. 지원 네트워크

- **Mainnet** (이더리움 메인넷)
- **Sepolia** (테스트넷)
- **Holesky** (테스트넷)
- **Hoodi** (테스트넷)

## 6. 지원 하드포크

Ethrex는 **포스트-머지(Post-Merge)** 전용 클라이언트로, 다음 포크를 지원한다:

- **Paris** (The Merge)
- **Shanghai**
- **Cancun**
- **Prague**
- **Osaka** (예정)
- **Amsterdam** (실험적, EIP-7928 포함)

## 7. 동기화 모드

| 모드 | 설명 |
|------|------|
| **Full Sync** | 제네시스부터 모든 블록을 다운로드하고 순차 실행 |
| **Snap Sync** | 피어로부터 상태 스냅샷을 다운로드한 후 최근 블록만 실행 |

## 8. 주요 기능 요약

### L1 기능
- 완전한 EVM 지원 (Prague 포크 포함)
- EIP-4844 블롭(Blob) 지원
- EIP-7928 블록 수준 접근 목록
- 상태 트라이 캐싱 및 레이어링
- Snap Sync 상태 동기화
- 멤풀 관리 및 트랜잭션 브로드캐스트
- 합의 클라이언트용 페이로드 빌딩
- Prometheus 메트릭 수집

### L2 기능
- 다중 프루버 아키텍처 (SP1, RISC Zero, Zisk, OpenVM, TEE)
- 시퀀서 운영
- 상태 차이(State Diff) 압축 및 블롭 게시
- L1-L2 양방향 통신 (입금/출금)
- Based 롤업 모드 지원 (개발 중)
- 타임락(Timelock) 컨트랙트
- 수수료 토큰 지원

### 개발자 도구
- JSON-RPC REPL (대화형 쿼리)
- 블록 임포트/익스포트 유틸리티
- 상태 루트 계산
- Flamegraph 프로파일링
- CPU 프로파일링 (선택적)
- Hive 테스트 호환

## 9. 워크스페이스 구조

```
ethrex/
├── cmd/ethrex/           # 메인 바이너리 (진입점)
├── crates/
│   ├── blockchain/       # 블록체인 코어 로직
│   │   ├── dev/          # 개발 모드
│   │   └── metrics/      # 메트릭 수집
│   ├── common/           # 공유 타입 및 유틸리티
│   │   ├── config/       # 네트워크 설정
│   │   ├── crypto/       # 암호화 프리미티브
│   │   ├── rlp/          # RLP 인코딩/디코딩
│   │   └── trie/         # Merkle Patricia Trie
│   ├── networking/
│   │   ├── p2p/          # P2P 프로토콜 스택
│   │   └── rpc/          # JSON-RPC API 서버
│   ├── storage/          # 영구 데이터 레이어
│   ├── vm/               # VM 추상화 레이어
│   │   └── levm/         # Lambda EVM (자체 EVM)
│   ├── l2/               # L2 시퀀서 및 롤업
│   │   ├── common/       # L2 공유 타입
│   │   ├── contracts/    # L1/L2 스마트 컨트랙트
│   │   ├── networking/rpc/ # L2 RPC 엔드포인트
│   │   ├── prover/       # 증명 생성기
│   │   ├── sdk/          # L2 SDK
│   │   └── storage/      # L2 전용 스토리지
│   └── guest-program/    # ZK 게스트 프로그램
├── tooling/              # EF 테스트, 유틸리티
├── test/                 # 통합 테스트
├── benches/              # 벤치마크
├── metrics/              # Grafana/Prometheus 설정
├── fixtures/             # 테스트 데이터
└── docs/                 # 문서
```

## 10. 크레이트 의존성 그래프

```
                        ┌─────────────────┐
                        │  cmd/ethrex     │
                        │  (메인 바이너리) │
                        └────────┬────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        v                        v                        v
    ┌──────────┐          ┌─────────────┐          ┌──────────┐
    │   RPC    │          │    P2P      │          │Blockchain│
    │(HTTP/WS) │          │(네트워킹)   │          │ (체인)    │
    └────┬─────┘          └─────┬───────┘          └────┬─────┘
         │                      │                       │
         └──────────────────────┼───────────────────────┘
                                │
                                v
                         ┌──────────────┐
                         │ LEVM (EVM)   │
                         └──────┬───────┘
                                │
                                v
                         ┌─────────────┐
                         │  Storage    │
                         └──────┬──────┘
                                │
                ┌───────────────┼───────────────┐
                v               v               v
            ┌──────────┐  ┌──────────┐  ┌──────────┐
            │   Trie   │  │   RLP    │  │  Types   │
            └──────────┘  └──────────┘  └──────────┘
```

## 11. 주요 의존성

| 라이브러리 | 용도 |
|-----------|------|
| `tokio` | 비동기 런타임 |
| `rocksdb` | 프로덕션 스토리지 백엔드 |
| `ethereum-types` | 이더리움 프리미티브 타입 |
| `secp256k1` | 암호화 서명 |
| `kzg-rs` | KZG 커밋먼트 (EIP-4844) |
| `serde` / `serde_json` | 직렬화/역직렬화 |
| `axum` | HTTP/RPC 서버 |
| `rayon` | 병렬화 |
| `rkyv` | 제로카피 직렬화 |
| `aligned-sdk` | Aligned Layer 통합 |
| `jemalloc` | 커스텀 메모리 할당자 |

## 12. 릴리스 프로파일

```toml
[profile.release]
opt-level = 3        # 최대 최적화
lto = "thin"         # 링크 타임 최적화 (빠른 링킹)
codegen-units = 1    # 더 나은 최적화 (컴파일 느림)
```
