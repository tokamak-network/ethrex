---
생성일: 2026-02-22
아이디어: Geth에서 ethrex로 안전하게 마이그레이션하는 CLI MVP를 설계하고 싶습니다. 핵심은 데이터 변환, 무결성 검증, 롤백 지원입니다.
버전: 1.0
프로젝트 유형: cli
---

```markdown
# PRD: Geth → Ethrex 마이그레이션 CLI MVP

---

## 1. 프로젝트 개요

이 프로젝트는 **Geth**(Go-Ethereum)의 로컬 데이터베이스(leveldb 기반)를 **Ethrex**(고성능, 모듈식 Ethereum 클라이언트)의 데이터 포맷으로 안전하게 마이그레이션하는 커맨드라인 인터페이스(CLI) 최소 기능 제품(MVP)을 설계 및 구현합니다.  
마이그레이션 과정에서 **데이터 무결성 보장**, **롤백 지원**, **진행 상황 로깅**, **에러 재시도 메커니즘**을 핵심으로 하며, Geth의 블록체인 데이터(채널, 상태, 트랜잭션, 수신자, 블록 헤더 등)를 Ethrex가 이해할 수 있는 구조로 변환합니다.  
이 CLI는 개발자 및 운영자가 블록체인 노드를 안전하게 교체할 수 있도록 지원하며, **시스템 다운타임을 최소화**하고 **데이터 손실을 제로**로 유지하는 것을 최우선 목표로 합니다.

---

## 2. 목표 및 비목표

### ✅ 목표
- Geth의 `geth/chaindata` 디렉터리 내 데이터를 Ethrex의 데이터 구조로 정확히 변환
- 변환 과정 중 데이터 손실 없이 무결성 검증 수행 (해시 기반 검증 + 구조적 일관성 검사)
- 마이그레이션 실패 시 원본 상태로 자동 롤백 기능 제공
- 진행 상황을 실시간 로그로 출력 (진행률, 처리된 블록 수, 에러 수 등)
- 일시적 오류(파일 잠금, I/O 지연, 네트워크 장애 등)에 대해 자동 재시도 메커니즘 구현
- CLI 사용자에게 명확한 오류 메시지 및 해결 가이드 제공

### ❌ 비목표
- Geth와 Ethrex의 네트워크 프로토콜 수정 또는 확장
- 블록체인 상의 상태를 실시간 동기화하는 온라인 마이그레이션 기능
- GUI 또는 웹 인터페이스 개발
- 다중 노드 간 병렬 마이그레이션 지원 (MVP 단계에서는 단일 노드만 대상)
- 고급 분석 기능 (예: 트랜잭션 분석, 수익 추적 등)
- Ethrex의 블록 생성 또는 합의 알고리즘 변경

---

## 3. 핵심 기능 요구사항

| ID     | 기능명 | 설명 | 입력 | 출력 | 비고 |
|--------|--------|------|------|------|------|
| **F-001** | Geth 데이터 파싱 | Geth의 `chaindata/` 디렉터리에서 LevelDB 데이터를 읽어 블록, 상태, 트랜잭션, 수신자 키를 구조화 | `--source=/path/to/geth/chaindata` | 파싱된 메타데이터 (블록 번호, 해시, 상태 루트, 트랜잭션 수 등) | 실패 시 `degraded mode`로 전환 (후술) |
| **F-002** | 데이터 변환 | Geth의 내부 포맷 → Ethrex의 사전 정의된 포맷으로 변환 (예: 블록 헤더 구조, 상태 트리 인덱스, 트랜잭션 RLP 인코딩) | 파싱된 Geth 데이터 | Ethrex 호환형 `ethrex/chaindata/` 디렉터리 구조 | 변환 로직은 사전 정의된 매핑 테이블 기반 |
| **F-003** | 무결성 검증 | 변환 후 데이터의 무결성을 검증: <br> - 블록 해시 일치성 검사 <br> - 상태 루트 일치성 검사 <br> - 트랜잭션 수 및 순서 일치성 검사 <br> - Merkle Proof 검증 (선택적) | Geth 원본 + Ethrex 변환 데이터 | 검증 결과 보고서 (성공/실패, 불일치 항목 리스트) | 실패 시 마이그레이션 중단 및 자동 롤백 |
| **F-004** | 롤백 기능 | 마이그레이션 실패 시, 원본 Geth 데이터를 복원 | `--source`, `--backup=/path/to/backup` | 원본 데이터 복원 완료 여부 | 마이그레이션 시작 전 자동 백업 생성 |
| **F-005** | 진행 상황 로깅 | 실시간 로그 출력: <br> - 처리 중인 블록 번호 <br> - 누적 처리 시간 <br> - 변환률 (%) <br> - 누적 에러 수 | 내부 처리 상태 | 터미널 로그 + 선택적 로그 파일 (`--log-file=path`) | 로그 레벨: INFO, WARN, ERROR |
| **F-006** | 에러 처리 및 재시도 | 네트워크/디스크 오류 시 자동 재시도 (최대 5회, 지수 백오프) | 오류 타입 (I/O, DB 잠금, 시간 초과 등) | 재시도 성공/실패 결과 | 재시도 간 대기: 1s, 2s, 4s, 8s, 16s |
| **F-007** | Degraded Mode (파싱 실패 대응) | Geth LevelDB 파싱이 완전히 실패할 경우, 최소한의 블록 헤더만 읽어 **기본 상태**로 마이그레이션 수행 | 파싱 실패 시 | 최소한의 블록 헤더 + 빈 상태 트리 생성 | **SYSTEM_BASELINE 준수**: 최소한의 데이터로라도 마이그레이션 시도 → 사용자에게 "기본 모드로 진행 중" 경고 출력 |

> 📌 **F-007 (Degraded Mode) 상세 (SYSTEM_BASELINE 기준)**  
> - Geth의 LevelDB가 심각하게 손상되어 정상 파싱이 불가능할 경우, CLI는 **파싱 단계를 포기**하고,  
> - `block_number=0`부터 `block_number=N`까지의 **헤더만** (비트코인 스타일의 헤더만) 추출하여  
> - Ethrex의 **빈 상태 트리**와 **헤더 체인**만 생성  
> - 이 상태는 **검증 불가능**하지만, **노드 재시작 후 체인 동기화 가능**하게 만듦  
> - 사용자에게 경고 메시지 출력:  
>   `"⚠️ [DEGRADED MODE] Geth 데이터 파싱 실패. 최소한의 블록 헤더만 사용하여 마이그레이션 진행. 상태 트리는 재동기화 필요."`  
> - 이 모드는 **MVP의 핵심 안전망**이며, **시스템이 완전히 다운되지 않도록 보장**함

---

## 4. 비기능 요구사항

### 🚀 성능
- **대규모 체인**(100M+ 블록) 기준, 변환 속도: **최소 500 블록/초** (SSD 기준)
- 전체 마이그레이션 시간: 100M 블록 기준 **최대 5.5시간** (1000 블록/초 기준)
- 메모리 사용량: **최대 8GB RAM** (대용량 상태 트리 캐싱 최적화)
- 롤백 시간: **10초 이내** (백업 크기 100GB 기준)

### 🔐 보안
- 원본 Geth 데이터 읽기 전용 모드로 접근 (쓰기 금지)
- 마이그레이션 중 원본 데이터 절대 수정 불가
- 백업 파일은 암호화되지 않으나, 접근 권한은 `0600`으로 제한
- CLI 실행 사용자는 `root` 권한 없이도 실행 가능 (필요 시 `sudo` 권한 요청)

### 📦 확장성
- 모듈화된 변환 플러그인 아키텍처 설계 (예: `transformer/geth-to-ethrex-v1.go`)
- 향후 다른 클라이언트 (Nethermind, Besu 등)로 확장 가능하도록 인터페이스 분리
- 로깅 시스템은 structured logging (JSON) 지원 → Prometheus/Grafana 연동 가능

---

## 5. 제약 조건

- **지원 OS**: Linux (Ubuntu 22.04+), macOS (Ventura+), Windows 11 (WSL2 전용)
- **Geth 버전**: v1.13.x ~ v1.14.x (leveldb 기반)
- **Ethrex 버전**: v0.1.0+ (공개된 데이터 포맷 사양에 의존)
- **디스크 공간**: 원본 Geth 데이터 크기의 **2.5배 이상** 여유 공간 필요 (원본 + 백업 + 변환 데이터)
- **네트워크**: 오프라인 환경에서 실행 가능 (온라인 연결 불필요)
- **라이선스**: Geth 데이터는 공개 블록체인 데이터이므로, 라이선스 제약 없음. Ethrex는 MIT 라이선스 기반.

---

## 6. 성공 지표 (KPI)

| 지표 | 목표 | 측정 방법 |
|------|------|-----------|
| 마이그레이션 성공률 | ≥ 99.5% | 100회 테스트 실행 중 실패 횟수 |
| 롤백 성공률 | 100% | 실패 시 반드시 원본 복원 여부 검증 |
| Degraded Mode 진입률 | ≤ 0.5% | 파싱 실패로 인한 degraded mode 진입 비율 |
| 평균 마이그레이션 시간 | ≤ 6시간 (100M 블록 기준) | 5회 테스트 평균 |
| 에러 재시도 성공률 | ≥ 90% | 재시도 후 성공한 오류 비율 |
| 사용자 만족도 (초기 피드백) | ≥ 4.5/5 | 10명 이상 개발자 대상 설문 |

---

## 7. 마일스톤

| 마일스톤 | 목표 | 마감일 | 달성 기준 |
|----------|------|--------|-----------|
| **M-01: 설계 승인** | 아키텍처 및 데이터 매핑 문서 승인 | Day 5 | 모든 팀원이 F-001~F-007 요구사항 동의, Degraded Mode 설계 승인 |
| **M-02: 파싱 모듈 구현** | Geth LevelDB 파서 완성 (F-001) | Day 12 | 단위 테스트 통과, 1000 블록 샘플 파싱 성공 |
| **M-03: 변환 모듈 구현** | Ethrex 포맷 변환 로직 구현 (F-002) | Day 18 | 변환된 데이터가 Ethrex 노드에서 정상 로드됨 |
| **M-04: 무결성 검증 구현** | 해시/상태 루트 검증 로직 완성 (F-003) | Day 22 | 검증 실패 시 명확한 오류 출력 + 중단 |
| **M-05: 롤백 및 백업 구현** | 백업/복원 기능 완성 (F-004) | Day 25 | 백업 생성 → 변환 실패 → 복원 → 원본 동일성 검증 완료 |
| **M-06: 로깅 및 재시도 구현** | 로그 시스템 + 재시도 로직 (F-005, F-006) | Day 28 | 로그 파일 생성, 재시도 5회 후 실패 시 정상 종료 |
| **M-07: Degraded Mode 구현** | SYSTEM_BASELINE 준수된 파싱 실패 대응 (F-007) | Day 30 | 손상된 LevelDB 시뮬레이션 테스트에서 degraded mode 진입 및 경고 출력 확인 |
| **M-08: MVP 배포** | CLI 실행 가능 패키지 배포 (Docker + Binary) | Day 35 | GitHub Releases에 v0.1.0 배포, README에 사용법 포함 |
| **M-09: 테스트 및 검증** | 50회 이상 테스트 실행, 성공 지표 달성 | Day 40 | 모든 KPI 목표 달성, 테스트 로그 공개 |

---

> ✅ **최종 체크리스트**:  
> - [ ] SYSTEM_BASELINE Degraded Mode 포함  
> - [ ] 모든 기능에 F-ID 부여  
> - [ ] 비기능 요구사항 명시  
> - [ ] 성공 지표 정량화  
> - [ ] 마일스톤에 일정 및 달성 기준 명시  
> - [ ] CLI 중심 설계 유지 (GUI/웹 제외)

```